/***************************************************************************************************
 * Licensed Materials - Property of IBM 
 * Â© Copyright IBM Corporation 2014, 2021. All Rights Reserved.
 * 
 * Note to U.S. Government Users Restricted Rights: Use, duplication or disclosure restricted by GSA
 * ADP Schedule Contract with IBM Corp.
 **************************************************************************************************/
define(["common/jquery-ext","common/config!","common/customEvents","common/htmlUtils","common/oauthUtils"],function(a,b,c,d,e){function f(a){this.contentType=a.contentType,this.url=a.url,this.postPaths=a.postPaths||[]}return f.prototype.checkUrlLength=function(){for(var b=!1,c=0;c<this.postPaths.length;c++)if(this.url.indexOf(this.postPaths[c])>-1){b=!0;break}if(this.url.length>2e3&&b){var d=this.url.split("?");this.url=d[0],this.postData=a.queryToObject(d[1])}},f.prototype.setUrl=function(a){return this.url=a,this.checkUrlLength(),this},f.ContentType={SparqlResults:"application/sparql-results+xml:xml",SparqlResultsJSON:"application/sparql-results+json:json",RDF:"rdf",XML:"application/xml:xml",TEXT:"html/text:text",JSON:"application/json:json"},f.Method={GET:"GET",POST:"POST"},f.Events={OAuthApprovalNeeded:"oauth-approval-needed"},c.Mixin(f),a.isOpenSocial()?f.prototype.send=function(c){var g=this,h=gadgets.io,i=h.RequestParameters,j={};j[i.CONTENT_TYPE]=this.contentType===f.ContentType.JSON?h.ContentType.JSON:h.ContentType.TEXT,j[i.AUTHORIZATION]=h.AuthorizationType.OAUTH,j[i.OAUTH_SERVICE_NAME]="SPARQL_Gateway",j[i.OAUTH_USE_TOKEN]="always",j[i.METHOD]=h.MethodType.GET,j[i.HEADERS]={"Accept-Language":b.locale,Cookie:document.cookie,"Gadget-Authorization":!0},this.postData&&(j[i.METHOD]=h.MethodType.POST,j[i.POST_DATA]=a.objectToQuery(this.postData)),h.makeRequest(this.url,function(b){if(b.oauthApprovalUrl)g.notify(f.Events.OAuthApprovalNeeded,b);else if(314===b.rc&&b.headers&&b.headers.location){var h=b.headers.location[0];if(h.indexOf("oauth-authorize")>0){var i=e.rewriteCallback(h);b.oauthApprovalUrl=i.authorizeUrl;var j=function(a,b){var d=g.url;g.setUrl(e.addTokenAndSecretToUrl(g.url,a,b)),g.send(c),g.setUrl(d)};b.doNotReload=!0,a(window).one("message",function(a){0===i.callbackUrl.indexOf(a.originalEvent.origin)&&j(a.originalEvent.data.oauth_token,a.originalEvent.data.request_token_secret)}),g.notify(f.Events.OAuthApprovalNeeded,b)}else g.notify("HTTP-"+b.rc,b)}else 200===b.rc?(b.text=d.decodeUTF8(b.text),b.data=d.decodeUTF8(b.data),c(b)):400===b.rc?(b.text=d.decodeUTF8(b.text),b.data=null,c(b)):g.notify("HTTP-"+b.rc,b)},j)}:f.prototype.send=function(b,c){var d=this.contentType.split(":"),f=d[0],g=d[1];if(f&&g){var h=this,i={type:"GET",error:function(a){var c=a.getResponseHeader("X-jazz-web-oauth-url");if(401===a.status&&c){var d=function(a,c){var d=h.url;h.setUrl(e.addTokenAndSecretToUrl(h.url,a,c)),h.send(b),h.setUrl(d)};e.authenticateAndResendRequest(c,d)}else b(a)},success:function(a,c,d){b({data:a,xhr:d})},beforeSend:function(a){a.setRequestHeader("Accept",f)},dataType:g};c&&(i.async=!1),this.postData&&(i.type="POST",i.data=this.postData,i.traditional=!0),a.ajax(this.url,i)}},f});