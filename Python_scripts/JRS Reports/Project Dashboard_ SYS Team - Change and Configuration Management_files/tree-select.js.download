/*******************************************************************************
 * Licensed Materials - Property of IBM
 * © Copyright IBM Corporation 2015, 2021. All Rights Reserved.
 * 
 * Note to U.S. Government Users Restricted Rights:
 * Use, duplication or disclosure restricted by GSA ADP Schedule
 * Contract with IBM Corp.
 *******************************************************************************/
define("common/tree-select",["common/filter-select","i18n!nls/filter-messages","common/customEvents","common/htmlUtils","i18n!nls/query-builder"],function(a,b,c,d,e){"use strict";function f(){return"treeSelect"+l++}function g(){return"search"+l++}function h(){return"clear"+l++}function i(a,d){function i(a){a.$dom.find("li").each(function(){var a=$(this),b=a.attr("data-index").indexOf(s);if(-1!=b){a.attr("data-text");$(this).parents("div.tree-select div.tree-select").removeClass("hide").show().prev().show().find(".icon-group-closed-small").removeClass("icon-group-closed-small").addClass("icon-group-open-small"),a.show(),a.next(".tree-select").show()}else a.hide(),a.find("> label > span.label-text").text(" "+a.attr("data-text")),a.next(".tree-select").hide()})}if(this.options=$.extend({},$.fn.treeSelect.defaults,a),this.level=0,this.isMultiple=!0,this.singleSelectName=null,!a.json)return void console.error("JSON for creating tree needs to be passed as argument.");if(this.filterSelects=[],this.id=f(),!a.noUnassigned){var k={children:{nodes:{}},label:b.unassignedLabel,value:this.id+"-unassigned",selectable:!0};k.children.nodes[b.unassignedItem]={label:b.unassignedItem,value:"Unassigned",selected:a.selectUnassigned},this.options.json.nodes.unshift(k)}var l=this.options.json;if(l.conditionFilter&&(this.options.parentInfoMap=l.conditionFilter.parentInfoMap),void 0!==l.multiple&&l.multiple===!1&&(this.isMultiple=!1),d.html(""),this.isMultiple){var m=$("<div>").append($("<input>").prop("id",this.id+"filter-select-all").prop("type","checkbox").addClass("filter-select-checkbox"));m.append("&nbsp;").append($("<label>").prop("for",this.id+"filter-select-all").html(b.SelectAllVisible)),d.append(m);var n=m.find("input"),o=this;n.click(function(){var a=$(this).prop("checked"),b=d.find(".filter-select-checkbox:visible");a?o.options.isFilterByFQN&&!o.options.isEnableHierarchicalSelection?b.each(function(){var a=$(this).parent().parent().parent().find(".tree-select").find(".filter-select-checkbox:visible");0==a.length&&$(this).prop("checked",!0)}):(b.each(function(a,b){0===a||$(b).prop("checked")||$(b).trigger("click")}),b.prop("checked",!0)):(b.each(function(a,b){0!==a&&$(b).prop("checked")&&$(b).trigger("click")}),b.prop("checked",!1))}),n.on("keyup",function(a){var b=a.keyCode?a.keyCode:a.which;"13"==b&&n.trigger("click")})}var p=g(),q=h(),r="<div class='input-group gadget-input-group-xs filter-select-filter-container'><input type='text' class='form-control input-sm' placeholder='"+(this.options.filterText||b.TypeToFilter)+"'><div class='input-group-btn'><button id="+p+" type = 'button' class='btn btn-default btn-sm'>"+e.search+"</button> <button id="+q+" type='button' class='bx--btn bx--btn--secondary bx--btn--sm clear-button'>×</button></div></div>";this.$filterContainer=$(r),d.append(this.$filterContainer),this.subtreesLoading=0,j.call(this,this.options.json,d,0),this.$dom.on("partialSelect",$.proxy(function(){this.$dom.find(".tree-select").trigger("partialSelect")},this));var s,o=this,t=o.$dom.find("li").length;return this.$treeSearchInput=this.$filterContainer.find("input"),this.$filterClear=this.$filterContainer.find("#"+q),this.$filterClear.click(function(){o.$treeSearchInput.val("").trigger("input"),$("#"+p).trigger("click")}),this.$treeSearchInput.on("input",function(a){s=$(this).val().toUpperCase()}),1e3>t?($("#"+p).remove(),this.$treeSearchInput.on("input",function(a){$(this).val().toUpperCase();i(o)})):(this.$filterSearch=this.$filterContainer.find("#"+p),this.$filterSearch.click(function(){i(o)}),this.$treeSearchInput.on("keydown",function(a){13===a.keyCode&&$("#"+p).trigger("click")})),c.install(this),this}function j(a,b,c){var e=$("<select>").addClass("hide").attr("multiple","multiple").attr("id",this.id+this.level.toString()),g=$("<div>").addClass("tree-select").append(e);g.on("partialSelect",function(a){$(this).find("input:checked").length>0?$(this).prev().find("> label").addClass("partial-select"):$(this).prev().find("> label").removeClass("partial-select"),a.stopPropagation()}),this.level++,1!==this.level&&g.css("margin-left",this.options.marginLeft+"px"),1===this.level||a.open||g.addClass("hide"),1!==this.level?b.after(g):(b.append(g),this.$dom=g);var h=!1,i=[],l=[],n=[];a.selected&&(h=!0),void 0!==a.multiple&&a.multiple===!1&&(e.removeAttr("multiple"),this.isMultiple=!1,a.name&&(this.singleSelectName=a.name),this.singleSelectName||(this.singleSelectName=f()));var o=a.nodes,p=[];$.each(o,function(a,b){var c='<option value="'+d.encodeHtml(b.value)+'"';c+=b.conflict&&b.originalLabel?' data-conflict="'+d.encodeHtml(b.value)+'">'+d.encodeHtml(b.originalLabel)+"</option>":'">'+d.encodeHtml(b.label)+"</option>",p.push(c),(b.selected||1==h)&&i.push(b.value),(void 0!==b.selectable||0==b.selectable)&&l.push(b.value),void 0!==b.altValue&&n.push({value:b.value,altValue:b.altValue})}),e.append(p.join(""));var q={sortItems:!0,nosearch:!0};this.singleSelectName&&(q.name=this.singleSelectName);var r=e.filterSelect(q),s=r.getControlsByValueMap();this.filterSelects.push(r),r.on(m.itemSelected,function(a,b){t.notify(m.itemSelected,b)}),void 0!==a.selectable&&a.selectable===!1&&$.each(s,function(a,b){b.checkbox.prop("disabled",!0),b.checkbox.css("display","none"),b.li.attr("data-index","")}),$.each(l,function(a,b){var c=s[b];c.checkbox.prop("disabled",!0),c.checkbox.css("display","none"),c.li.attr("data-index","")}),$.each(n,function(a,b){var c=s[b.value];c.li.attr("data-altValue",b.altValue)}),r.selectItems(i,!0,!1,this.options),this.options.isFilterByFQN&&!this.options.isEnableHierarchicalSelection&&r.$dom.find("input").on("click",$.proxy(function(a){var b=$(a.target);b.is(":checked")&&(b.parents(".tree-select").prev().find("input").prop("checked",!1),b.closest("li").next().hasClass("tree-select")&&b.closest("li").next().find("input").prop("checked",!1)),this.$dom.trigger("partialSelect")},this));var t=this;$.each(o,function(a,b){var d=s[b.value];if(b.children){var e=d.li,f=$('<button class="icon-folder btn btn-link"></button>');b.children.open?f.addClass("icon-group-open-small"):f.addClass("icon-group-closed-small"),f.click(k),e.find("input")&&"none"===e.find("input").css("display")&&e.click(k),d.checkbox.before(f),b.children.multiple=t.isMultiple,t.singleSelectName&&(b.children.name=t.singleSelectName),t.subtreesLoading++,j.call(t,b.children,e,c+1),t.subtreesLoading--}else{var f=$('<span class="icon-folder icon-group-hidden"></span>');d.checkbox.before(f)}})}function k(a){var b=$(this).hasClass("icon-folder")?$(this):$(this).find(".icon-folder");b.hasClass("icon-group-open-small")?(b.removeClass("icon-group-open-small").addClass("icon-group-closed-small"),b.closest("li").next().slideUp(400)):b.hasClass("icon-group-closed-small")&&(b.removeClass("icon-group-closed-small").addClass("icon-group-open-small"),b.closest("li").next().removeClass("hide").slideDown(400)),a.stopPropagation(),a.preventDefault()}var l=0,m=a.Events;i.prototype.getSelectedValues=function(){var a=[];return $.each(this.filterSelects,function(b,c){a=a.concat(c.getSelectedValues())}),a},i.prototype.getSelectedTexts=function(){var a=[];return $.each(this.filterSelects,function(b,c){a=a.concat(c.getSelectedTexts())}),a},i.prototype.treeIsLoaded=function(){return this.subtreesLoading<=0},i.prototype.selectItems=function(a,b,c){$.each(this.filterSelects,function(d,e){e.selectItems(a,b,c)}),this.openSelectedHierarchies()},i.prototype.getOptions=function(a,b){var c=[];return $.each(this.filterSelects,function(d,e){c=c.concat(e.getOptions(a,b))}),c},i.prototype.openSelectedHierarchies=function(a,b){this.$dom.find("input:checked").each(function(){$(this).parents("div.tree-select").removeClass("hide").show().prev().find(".icon-group-closed-small").removeClass("icon-group-closed-small").addClass("icon-group-open-small")}),this.$dom.trigger("partialSelect")},i.checkAndAddParent=function(a){"string"===$.type(a)&&(a=$.parseXML(a));for(var b=a.getElementsByTagName("Value"),c=($(a),{}),d=0;d<b.length;d++){var e=$(b[d]);c[e.attr("id")]=e}for(var f={},d=0;d<b.length;d++){var e=$(b[d]),g=e.text(),h=e.attr("parentId");if(void 0==h)return a;var j=e.attr("id");if(f[j]={path:[],item:e},"-1"!=h){var k=c[h];if(k){var l=k.text().split(i.ProjectDelimiter)[0].trim().split("/")[0].trim();g.slice(0,l.length)!==l&&e.text(l+"/"+g)}}}for(var d=0;d<b.length;d++){var m=$(b[d]),j=m.attr("id"),n=f[j],o=n.path;o.push(m.attr("name"));for(var h=m.attr("parentId");;){if("-1"===h)break;var p=f[h];if(!p)break;var k=p.item;if(!k)break;o.splice(0,0,k.attr("name")),h=k.attr("parentId")}m.attr("path",JSON.stringify(o))}return a},i.ProjectDelimiter=" -- ",i.rqmTreeDelimiter=" ~~~ ",i.buildHierarchyArray=function(a,b,c){var d=a.lastIndexOf(i.ProjectDelimiter);if(-1==d)return[];var e=a.substring(d+i.ProjectDelimiter.length),f=function(a,b){var c=a.replace(new RegExp("^[ ]*"+b,""),"");return c=c.replace(new RegExp(b+"[ ]*$"),""),c.split(b)},g=a.substring(0,d),h=[g];return c&&(b?h=JSON.parse(b):a.indexOf(i.rqmTreeDelimiter)>-1?h=f(g,i.rqmTreeDelimiter):(a.indexOf("/")>-1||"/"===g[0])&&(h=f(g,"/"))),h.unshift(e),h},i.parseHierarchy=function(a,b,c){var d={selectable:!1,nodes:[]},e={};return $.each(a,function(a,d){if("Unassigned"!=d.value&&d.text){var f=i.buildHierarchyArray(d.text,d.path,b);if(f.length>0){var g=f.shift(),h=e[g];h||(h=e[g]={value:g,label:g,altValue:g}),h.children||(h.children={open:"config"!==b},h.children.nodes={});var j=h.children.nodes;$.each(f,function(a,b){if(b=b.trim(),""!=b){var e,g=a===f.length-1;e=g?d.value:b;var h=!1,i=j[b];i&&g&&i.leaf&&i.value!==e&&(i.conflict=h=!0,i.originalLabel=i.label);var k=b;if(h)for(var l=1;i;)k=b+"#@{"+l+"}@#",i=j[k],l++;i||(i=g?{value:e,label:k,leaf:!0}:{value:e,label:k,leaf:!1,selectable:!1},h&&(i.conflict=!0,i.originalLabel=b),c&&$.each(c,function(a,b){i.value===b&&(i.selected=!0)}),j[k]=i),g?(i.value=e,i.leaf=!0,delete i.selectable,c&&$.each(c,function(a,b){i.value===b&&(i.selected=!0)})):(i.leaf=!1,i.children||(i.children={},i.children.nodes={}),j=i.children.nodes)}})}}}),$.each(e,function(a,b){d.nodes.push(b)}),d},i.isTree=function(a,b){if(b){var c=b.find("Values");if(c.length>0){var d=c[0];if("true"===$(d).attr("tree"))return!0}else if(c=b.find("results"),c.length>0&&c.find("config").length>0&&c.find("config_type").length>0)return"config"}return!1},i.isFilterByFQN=function(a,b){if(b){var c=b.find("Values");if(c.length>0){var d=c[0];if("true"===$(d).attr("filterByFQN"))return!0}}return!1},i.isFilterByTwoLevels=function(a,b){if(b){var c=b.find("Values");if(c.length>0){var d=c[0];if("true"===$(d).attr("filterByTwoLevels"))return!0}}return!1},i.isEnableHierarchicalSelection=function(a,b){if(b){var c=b.find("Values");if(c.length>0){var d=c[0];if("true"===$(d).attr("enableHierarchicalSelection"))return!0}}return!1};var n="jrs.filter.treeSelect";return i.getInstance=function(a){return a.data(n)},i.removeInstance=function(a){a.data(n,null),a.empty()},$.fn.treeSelect=function(a){var b=i.getInstance($(this));if(!b){var b=new i(a,$(this[0]));$(this).data(n,b)}return b},$.fn.treeSelect.defaults={marginLeft:15},i});