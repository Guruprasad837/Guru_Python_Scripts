/*******************************************************************************
 * Licensed Materials - Property of IBM
 * Â© Copyright IBM Corporation 2014, 2020. All Rights Reserved.
 *
 * Note to U.S. Government Users Restricted Rights:
 * Use, duplication or disclosure restricted by GSA ADP Schedule
 * Contract with IBM Corp.
 *******************************************************************************/
define(["./report-parameter","common/templates","common/request","common/customEvents","queries/vocabularies","common/filter-select","common/tree-select","i18n!nls/query-builder","i18n!nls/messages","i18n!nls/filter-messages","common/htmlUtils"],function(a,b,c,d,e,f,g,h,i,j,k){function l(a,b){if("@"==b[0]){var c=b.substring(1);if(c.length>0)return a.attr(c);var d=a.html();return d||(d=a.text()),d}var e=a.find(b);if(e.length>0){var f=e.get(0).childNodes;if(f&&f.length>0)return f[0].nodeValue}return""}var m=!1,n=!1,o=e.SR,p=f.Events,q="ProjectIds",r=null,s=d.CreateEventEnums("ParentFilterChanged");return function(b){r=b.gadget;var e=new a(b);if(e.getQueryVariable()===q&&(a.limitScopeFilter=e),d.install(e),b.parentFilter&&(e.parentFilter=b.parentFilter,e.parentFilter.hasChildren=!0,b.rptParam.required)){if(e.parentFilter.getQueryVariable()!=q)var t=e.parentFilter.makeRequired(!0);t||(r.forcedFilterMessage=$.expand(__GadgetMessages.ParentFilterForcedRequired,[e.title()]))}return e.parentFilter&&(e.parentFilter.on(s.ParentFilterChanged,function(a,b){b.id!==e.id&&(e.queryPending=b,e.modified(!0))}),e.parentFilter.parentFilter&&e.parentFilter.parentFilter.on(s.ParentFilterChanged,function(a,b){b.id!==e.id&&(e.queryPending=b,e.modified(!0))})),this.queryIsRunning=!1,e.onShow=function(){var a=this;this.queryPending?(this.queryPending=!1,this.runQuery&&this.runQuery()):a.isTree&&!a.isTreeUILoaded()&&a.loadTreeUI()},e.onShown=function(){this.areValuesLoaded()?this.isTree&&!this.isTreeUILoaded()&&this.loadTreeUI():this.$_refreshButton.click()},e.$_selectAllButton.click(function(){e.$filterSelect.selectItems(null,!0,!0),e.showDisplayValues()}),e.$_clearAllButton.click(function(){e.$filterSelect.selectItems(null,!1,!0),e.showDisplayValues()}),e.areValuesLoaded=function(){return void 0!==this.$selection},e.isMultiSelect=function(){return this._rptParam.multiSelect},e.isMetamodelKind=function(){return this._rptParam.parameterKind==o.uMetamodelKind},e.isUserKind=function(){return"User:ID"==this._rptParam.parameterQuerySubjectVariable},e.isProjectKind=function(){if(this._rptParam.reportQueryVariable===q)return!0;var a=this._rptParam.parameterQuery;if(a){a=decodeURIComponent(a);var b="property=",c=a.indexOf(b);if(-1!=c){c+=b.length;var d=a.indexOf("&",c);-1==d&&(d=a.length);var e=a.substring(c,d),f=".PROJECT_NAME";if("process:projectArea"==e||-1!==e.indexOf(f,e.length-f.length))return!0}}return!1},e.runQuery=function(a,b){var c=this,d=setInterval(function(){c.queryIsRunning?b&&b.performRefresh||clearInterval(d):(clearInterval(d),c.modified(!1),c.runQueryNow(a,b))},50)},e.runQueryNow=function(b,d){var e=this._rptParam,f=this.parentFilter,h=null,i=null,o=null;if(d&&d.revertValues&&(this.unsavedValues=void 0),f){var p=this._rptParam.dependsOnParameterQueryVariable,q=f._rptParam.dependsOnParameterQueryVariable,s=!0;if("@projects"===p||"@projects"===q){s=!1;var t="@projects"===p?f.getValues():f.parentFilter.getValues();if(t&&0!==t.length||a.limitScopeFilter&&(t=a.limitScopeFilter.getValues()),t&&t.length>0){i="numProjects="+t.length;for(var u=0;u<t.length;u++)i+="&p"+u+"="+t[u]}}if("@components"===p){s=!1;var v=f.getValues();if(v&&v.length>0){o="numComponents="+v.length;for(var w=0;w<v.length;w++)o+="&comp"+w+"="+v[w]}}if(s&&(h=f.getQueryFilterString(p)),null===h&&s){var x=$.expand(__GadgetMessages.SelectParentFilterValues,[f.title()]);return this.contents($("<div style='padding:20px;text-align:center'>"+x+"</div>")),this.showSelectionLinks(!1),void(b&&b())}}if(h&&(h="fields="+encodeURIComponent("results/result["+h+"]")),this.showSelectionLinks(!this.isTree),!e.parameterQuery&&!e.parameterQuery_)return void(b&&b());n||"undefined"!=typeof e&&"undefined"!=typeof e.filterOperator&&(m=!("is"===e.filterOperator||"is any of"===e.filterOperator),n=!0),n||"undefined"!=typeof f&&"undefined"!=typeof f._rptParam.filterOperator&&(m=!("is"===f._rptParam.filterOperator||"is any of"===f._rptParam.filterOperator),n=!0);var y=e.parameterQuery?e.parameterQuery:e.parameterQuery_,z=this.isMetamodelKind();if(z)y=y.replace("((endpointUrl))",encodeURIComponent(__queryEndpoint)),i&&(y+="&"+i),o&&(y+="&"+o),d&&d.searchString?(y+="&searchString="+encodeURIComponent(d.searchString)+"&showArchived=true",this.searchString=d.searchString):this.searchString=void 0;else{y+="/dataservice";var A="?";i&&(y+=A+i,A="&"),o&&(y+=A+o,y+="&isNotOperator="+m.toString())}this.request||(this.request=new c({url:y,contentType:c.ContentType.SparqlResults,postPaths:["view/partial","numProjects","numComponents"]})),h&&!z&&(y+="?"+h),this.request.setUrl(y),this.contents(this.templates.get("_queryLoad")),this._values={},this.queryIsRunning=!0;var B=this;this.request.send(function(a){B.xml=a.data,"string"==typeof B.xml&&(B.xml=$.parseXML(B.xml)),B.xml&&g.checkAndAddParent(B.xml),B.$selection=$("<select>",{id:e.reportQueryVariable}),B.$selection.hide(),e.multiSelect&&B.$selection.prop("multiple",!0),B.contents(B.$selection),B.results=$(B.xml),B.uniqueValues={};var f="result",h=e.parameterQuerySubjectVariable;if(z){var i=e.parameterQuerySubjectVariable.split(":");2===i.length?(f=i[0],h=i[1]):f="Value"}B.treeValues=[],B.selectOptions=[],B.moreValuesExist&&(B.unsavedOptions&&(B.selectOptions=B.unsavedOptions.slice(0)),B.unsavedValues&&B.unsavedValues.forEach(function(a){B.uniqueValues[a]=!0})),B.xml&&1===B.xml.getElementsByTagName("MoreValuesExist").length&&(B.moreValuesExist=!0,B.numReturned=B.results.find(f).length);var m;if(B.results.find(f).each(function(a,b){var c=$(b),d=l(c,h),f=l(c,e.parameterQueryDisplayNameVariable),g=l(c,"@path"),i={value:d,text:f};if(g&&(i.path=g),j.unassignedItem===d&&(m=!0),B.treeValues.push(i),!B.uniqueValues.hasOwnProperty(d)){B.uniqueValues[d]=f;var n='<option value="'+k.encodeHtml(d)+'">'+k.encodeHtml(f)+"</option>";B.selectOptions.push(n)}}),!m&&B.isMultiSelect()&&!B.isUserKind()&&!B.isProjectKind()){var n='<option value="Unassigned">'+j.unassignedItem+"</option>";B.selectOptions.unshift(n)}B.performRefresh=d&&d.performRefresh;var o=!0;if(B.moreValuesExist&&!B.unsavedOptions){var p=r.getPrefValues();if(B.isUserKind()&&p&&p.values){var p=p.values[B._rptParam.reportQueryVariable];if(p&&p.length>0&&"unassigned"!=p[0]&&"currentuser"!=p[0]){o=!1;var q=e.parameterQuery?e.parameterQuery:e.parameterQuery_;q=q.replace("((endpointUrl))",encodeURIComponent(__queryEndpoint)),q+="&userIds="+p.join();var s=new c({url:q,contentType:c.ContentType.SparqlResults});s.send(function(c){var d=c.data?$(c.data).find("User"):[];if(d.length>0)for(var e=0;e<d.length;e++){var f=$(d[e]).find("ID").text(),g=$(d[e]).find("Name").text(),h='<option value="'+f+'">'+k.encodeHtml(g)+"</option>";B.selectOptions.push(h)}else for(var e=0;e<p.length;e++){var h='<option value="'+p[e]+'">'+k.encodeHtml(p[e])+"</option>";B.selectOptions.push(h)}B.finishRunningQuery(b,a,B)},{})}}}o&&B.finishRunningQuery(b,a,B)})},e.isTreeUILoaded=function(){return void 0==this.$filterSelect?!1:this.$filterSelect.treeIsLoaded?this.$filterSelect.treeIsLoaded():!0},e.loadTreeUI=function(){var a=this;if(!a.$filterSelect||a.$filterSelect.options.json.treeValues!=a.treeValues){a.$filterSelect=void 0,a.$selection.hide(),g.removeInstance(a.$paramContent);var b=a.preferredValues(),c=g.parseHierarchy(a.treeValues,!0,b);c.multiple=a._rptParam.multiSelect,c.name=e.id,c.treeValues=a.treeValues,a.conditionFilter&&(c.conditionFilter=a.conditionFilter),filterSelect=a.$filterSelect=a.$paramContent.treeSelect({json:c,noUnassigned:!1,selectUnassigned:b&&b.indexOf("Unassigned")>-1}),a.$selection.remove(),filterSelect.on_(p.itemSelected,function(){a.notify(s.ParentFilterChanged,{id:a.id,variable:a._rptParam.dependsOnParameterQueryVariable,values:filterSelect.getSelectedValues()})}),a.showSelectionLinks(!1),a.initializeFilterSelect(filterSelect)}},e.finishRunningQuery=function(a,b,c){c.$selection.append(c.selectOptions.join(""));var d,e=g.isTree(c.treeValues,c.results);if(e)c.isTree=!0,(c.performRefresh||void 0!=c.$filterSelect||c.$filterToggle.hasClass("collapse in"))&&c.loadTreeUI();else if(c.moreValuesExist){var i={dynamicSearch:!0};c.searchString&&(i.searchString=c.searchString),d=c.$filterSelect=c.$selection.filterSelect(i,c.selectOptions),d.on_(f.Events.search,function(a,b){c.unsavedValues=c.getValues(),c.unsavedOptions=d.getOptionStrings(f.States.Selected),c.runQuery(null,b)}),c.xml&&1===c.xml.getElementsByTagName("MoreValuesExist").length?c.numReturned>0?d.updateUserMessage(h.tooManyResults.replace("{0}",c.numReturned),!0):d.updateUserMessage(h.tooManyResultsRefineFirst,!0):d.updateUserMessage(h.matchingResults,!1),c.initializeFilterSelect(d)}else d=c.$filterSelect=c.$selection.filterSelect({}),c.initializeFilterSelect(d);c.finishLoading(a,b,c)},e.initializeFilterSelect=function(a){var b=this;a.on_(p.itemSelected,function(){b.notify(s.ParentFilterChanged,{id:b.id,variable:b._rptParam.dependsOnParameterQueryVariable,values:a.getSelectedValues()})}),a.title=b.title(),a.on(p.itemSelected,function(a,c){if(!b.unsavedValues&&b.preselectedValues&&b.preselectedValues.length>0&&(b.unsavedValues=[],$.map(b.preselectedValues,function(a,c){b.unsavedValues.push(a)})),c.item&&"radio"!==$(c.item).attr("type")){var d=c.item.closest(".panel-collapse"),f=$(d).find('input[type="checkbox"]');if(d&&f.length>0&&f[0].id&&-1!==f[0].id.indexOf("filter-select-all")){var g=!0;f.map(function(){return"none"!==$(this).css("display")?$(this):void 0}).each(function(a,b){a&&(g=g&&$(b).prop("checked")?$(b).prop("checked"):!1)}),$(f[0]).prop("checked",g?g:!1)}if(1==c.item.prop("checked"))b.unsavedValues||(b.unsavedValues=[]),b.unsavedValues.push(c.value);else if(b.unsavedValues&&b.unsavedValues.length>0){var h=b.unsavedValues.indexOf(c.value);-1!=h&&(h==b.unsavedValues.length-1?b.unsavedValues.pop():b.unsavedValues[h]=b.unsavedValues.pop())}}else b.unsavedValues||(b.unsavedValues=[]),b.unsavedValues.length>0?b.unsavedValues[0]=c.value:b.unsavedValues.push(c.value);var j=b.showDisplayValues();j.includes(i.noFilter)?(e.updateRequired(!0),e.updateWarning(!0)):(e.updateRequired(!1),e.updateWarning(!1))}),b._rptParam.reportQueryVariableKind===o.uConfigurationPickerKind&&($.isEmptyObject(b.uniqueValues)?b.title(a.title+"<br><b>* "+i.noConfigurationsFound):b.title(a.title))},e.updateSelectedValuesInUI=function(){if(this.isTree)return void this.showDisplayValues();var a=this.preferredValues();a?this.setSelectedValues(a):this.showDisplayValues()},e.preferredValues=function(){if(this.unsavedValues)return this.unsavedValues;var a=r.getPrefValues();return a&&a.values?a.values[this._rptParam.reportQueryVariable]:null},e.finishLoading=function(a,b,c){c.updateSelectedValuesInUI(),c.queryIsRunning=!1,a&&a(b,c)},e.start=function(a){this.$_refreshButton.removeClass("hide"),this.showSelectionLinks(!this.isTree),this.isMultiSelect()||this.$_selectAllButton.hide(),this.request=a.request;var b=this;return this.$_refreshButton.click(function(){return b.unsavedValues=b.getValues(),b.moreValuesExist&&(b.unsavedOptions=b.$filterSelect.getOptionStrings(f.States.Selected)),b.runQuery(null,{performRefresh:!0}),!1}),a.autoQuery&&this.runQuery(),this},e.showSelectionLinks=function(a){a?this.$_selectionGroup.removeClass("hide"):this.$_selectionGroup.addClass("hide")},e.getDisplayValues=function(a){if(!this.$filterSelect){var b=this.getValues();if(b&&b===this.preselectedValues){this.originalTitle,this.columnId;if(window.parent&&window.parent.document&&this._rptParam){var c=this._rptParam.title,d=c;c&&c.trim&&(c=c.trim(),d=c.replace(/ *\([^)]*\) */g,""));var e=$(window.parent.document).find(".summary-part-condition-values .filter-text");if(e&&e.length>0&&c){for(var f="",g=0;g<e.length;g++){var h=e.get(g),i=$(h).find(".filter-attribute");if(i){var j=i.text().trim();if(j===c||j===d){var k=$(h).find(".filter-choice");if(k){var l=k.text().trim();if(l){f=l;break}}}else if(-1!=j.indexOf("(")){var m=j.replace(/ *\([^)]*\) */g,"");if(m===d){var k=$(h).find(".filter-choice");if(k){var l=k.text().trim();l&&(f=l)}}}}}return f}}return this.isTree&&!this.isTreeUILoaded()?(a=a?a:this.unsavedValues?this.unsavedValues:this.preselectedValues?this.preselectedValues:void 0,this.getTextFromTreeValues(a)):""}return b}return a&&this.$filterSelect.getTextsByValues?this.$filterSelect.getTextsByValues(a):this.isTree&&!this.isTreeUILoaded()?(a=a?a:this.unsavedValues?this.unsavedValues:this.preselectedValues?this.preselectedValues:void 0,this.getTextFromTreeValues(a)):this.$filterSelect.getSelectedTexts()},e._getValuesFromUI=function(){return this.$filterSelect?this.$filterSelect.getSelectedValues():void 0},e._updateUI=function(a){(!this.isTree||this.isTreeUILoaded())&&(this.$filterSelect.selectItems(null,!1),a&&this.$filterSelect.selectItems(a,!0),this.showDisplayValues())},e.getValues=function(){if(!this.areValuesLoaded())return this.preselectedValues;if(this.isTree&&!this.isTreeUILoaded())return this.unsavedValues?this.unsavedValues:this.preselectedValues;var a=this._getValuesFromUI();return 0===a.length?null:a},e.setSelectedValues=function(b){if(a.prototype.setSelectedValues.apply(this,[b]),this.areValuesLoaded()){if(this.isTree&&!this.isTreeUILoaded()){var c=e.getTextFromTreeValues(b);return void this.showDisplayValues(null,c)}this._updateUI(b)}},e.getTextFromTreeValues=function(a){if(!a)return a;var b=this,c=$.map(a,function(a){var c=b.$selection.find('option[value="'+a+'"]')[0];if(c){var d=g.buildHierarchyArray(c.text,null,!0);return 0==d.length&&"Unassigned"==a?c.text:d[d.length-1]}return""});return c},e}});