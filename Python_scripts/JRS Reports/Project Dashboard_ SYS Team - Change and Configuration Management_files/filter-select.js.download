/*******************************************************************************
 * Licensed Materials - Property of IBM
 * © Copyright IBM Corporation 2014, 2024. All Rights Reserved.
 * 
 * Note to U.S. Government Users Restricted Rights:
 * Use, duplication or disclosure restricted by GSA ADP Schedule
 * Contract with IBM Corp.
 *******************************************************************************/
define(["common/jquery-ext","common/customEvents","i18n!nls/filter-messages","common/htmlUtils","common/tooltipUtils","i18n!nls/query-builder","i18n!nls/messages"],function(a,b,c,d,e,f,g){"use strict";function h(b,c,d){return a(c,{"class":b,id:d?"":b})}function i(){return h("list-group filter-select-item-list","<ul>")}function j(c,d){this.$select=a(d),this.options=a.extend({},j.DEFAULT_OPTIONS,c),this.$dom=h("filter-select-container","<div>",this.options?this.options.enableSelectAll:!0),this.options.nosearch?this.$filterContainer=a("<div>").prependTo(this.$dom):this._makeFilterInput(),this.$list=i().appendTo(this.$dom),this.$list.attr("tabindex","-1"),this._fillItemList(),this.$select.parent().append(this.$dom),this.$select.css("display","none"),this.options.height&&this.$list.css("height",this.options.height),this.options.maxHeight&&this.$list.css("max-height",this.options.maxHeight),b.install(this)}function k(b,c,f,h,i){c=c.replace(/&amp;#47;/g,"&#47;");var j=d.encodeHtml(d.decodeHtml(c)),k=d.encodeHtml(d.decodeHtml(b)),l=f?"radio":"checkbox",m='<li data-text="'+j+'" data-index="'+j.toUpperCase()+'"><label><input type="'+l+'" value="'+k+'" name="'+f+'" class="filter-select-checkbox" ><span class="label-text"> '+j+"</span></input></label></li>",n=a(m),o=n.find(":first-child"),p=n.find(".filter-select-checkbox");return i&&e.addTooltipToExistingElement(o,i,g.WebUI_AttributeDescription),h&&o.append(a("<span></span>").addClass("conflict").attr("title",h)),{li:n,checkbox:p,label:o}}var l=300,m=j.prototype;m._makeFilterInput=function(){var b=this,d="<div class='input-group gadget-input-group-xs filter-select-filter-container'>";return d+=this.options.searchString?"<input type='text' class='form-control input-sm' value='"+this.options.searchString+"'>":"<input type='text' class='form-control input-sm' placeholder='"+(this.options.filterText||c.TypeToFilter)+"'>",d+="<div class='input-group-btn'>",d+="<button id='clear-action' type='button' class='bx--btn bx--btn--secondary bx--btn--sm clear-button'>×</button>",this.options.dynamicSearch&&(d+="<button id='search-action' type='button' class='bx--btn bx--btn--secondary bx--btn--sm' style='margin-left:16px;'>"+f.search+"</button>"),d+="</div></div>",this.$filterContainer=a(d).prependTo(this.$dom),this.$filterInput=this.$filterContainer.find("input"),this.options.filterWidth&&this.$filterInput.css("width",this.options.filterWidth),this.$filterContainer.css("max-width",l),this.options.dynamicSearch||this.$filterInput.on("input",function(c){var d=b.controlsByValue,e=b.optionValues,f=a(this).val().toUpperCase(),g=(b.getListItems(j.States.Selected),b.$list);""==f?(a.each(e,function(){var a=d[this];a&&a.li.show().removeClass("filter-select-last-checked-item")}),g.scrollTop(0)):(b.moveSelectedItemsToTop(),a.each(e,function(){var a=d[this],b=a?d[this].li:null;if(b){var c=b.find("input").prop("checked");b.attr("data-text").toUpperCase().indexOf(f)>-1?b.show():c||b.hide()}}))}),this.$filterClear=this.$filterContainer.find("#clear-action"),this.$filterClear.click(function(){b.$filterInput.val("").trigger("input")}),this.options.dynamicSearch&&(this.$filterSearch=this.$filterContainer.find("#search-action"),this.$filterSearch.click(function(){b.notify(j.Events.search,{searchString:b.$filterInput.val().toLowerCase()})}),this.$filterClear.click(function(){b.notify(j.Events.search,{searchString:""})})),this},m.clearFilterInput=function(){this.$filterClear&&this.$filterClear.trigger("click")},m.unselectAll=function(){var b=this.getListItems(j.States.Selected);a.each(b,function(b){a(this).selected=0})},m.moveSelectedItemsToTop=function(){var b=(this.controlsByValue,this.optionValues,this.getListItems(j.States.Selected)),c=this.$list,d=null;a.each(b,function(b){var e=a(this).removeClass("filter-select-last-checked-item");0===b?c.prepend(e):e.insertAfter(d),d=e}),d&&d.addClass("filter-select-last-checked-item")},m._fillItemList=function(){var b=this;if(this.multiSelect=this.$select.prop("multiple"),this.options.showSubtypesButton){const d=a("#createTableDataTab").attr("data-isAttributeSubtypesShown");"true"!==d&&(this.options.showSubtypesButton=!1)}if(this.options.showSubtypesButton){this.$filterContainer.css("padding-top","5px"),a("#choose-attribute").css("margin-bottom","0px"),this.$filterSubtypesContainer=i().css("height","auto").css("padding-bottom","0").addClass("filter-subtypes-list").insertAfter(this.$filterContainer);var e=k("",this.options.includeAttributesFromSubtypesText||c.IncludeAttributesFromSubtypes);this.$filterSubtypesContainer.append(e.li),e.checkbox.prop("checked",!0),e.checkbox.on("click",function(){b.showSubtypeAttributes(a(this).prop("checked")),window.localStorage.IncludeAttributesFromSubtypesCheckState=a(this).prop("checked")}),e.checkbox.on("keyup",function(a){var b=a.keyCode?a.keyCode:a.which;"13"==b&&e.checkbox.trigger("click")}),this.$filterSubItems=e.checkbox}if(this.multiSelect&&this.options.enableSelectAll){this.$selectAllContainer=i().css("height","auto").css("padding-bottom","0").addClass("filter-select-all-list").insertAfter(this.$filterContainer),this.$filterSubtypesContainer?(this.$selectAllContainer.css("padding-top","0"),this.$selectAllContainer.insertAfter(this.$filterSubtypesContainer)):this.$selectAllContainer.insertAfter(this.$filterContainer);var e=k("",this.options.selectAllText||c.SelectAll);this.$selectAllContainer.append(e.li),e.checkbox.on("click",function(){b.notify(j.Events.beforeSelectAll,{}).selectItems(null,a(this).prop("checked")).notify(j.Events.afterSelectAll,{})}),e.checkbox.on("keyup",function(a){var b=a.keyCode?a.keyCode:a.which;"13"==b&&e.checkbox.trigger("click")}),this.$selectAll=e.checkbox}this.multiSelect&&this.options.enableSelectAll||this.options.showSubtypesButton||this.$filterContainer.css("margin-bottom","5px"),this.inputName=void 0,this.multiSelect||(this.inputName=this.options.name,this.inputName||(this.inputName=this.$select.attr("id")));var f=this.$list,g=this.controlsByValue={},h=this._selectOptions(this.options.sortItems);this.optionValues=a.map(h,function(c){return b._getOptionValue(a(c))}),!this.options.dynamicSearch&&h.length<8?this.$filterContainer.addClass("hide"):this.$filterContainer.removeClass("hide");var l=[];return h.each(function(d,e){var f=a(e);if(!b.options.attributes||"true"!=f.attr("data-hidden")){var h=b._getOptionValue(f),i=f.attr("data-conflict"),m=f.attr("data-description"),n=f.attr("data-keeplocal"),o=f.text();"true"===n&&(o+=c.Promoted);var p=k(h,o,b.inputName,i,m);p.option=f,g[h]=p,p.checkbox.click(function(){var c=a(this);b._updateSelectAll().notify(j.Events.itemSelected,{value:c.val(),item:a(this)}),c.val()>-1&&(a(".icon-folder.icon-group-open").trigger("close"),a(".resource-subtypes > #filter-select-container.filter-select-container").remove())}).attr("data-role","list-item"),p.checkbox.on("keyup",function(a){var b=a.keyCode?a.keyCode:a.which;"13"==b&&p.checkbox.trigger("click")}),p.label.css("font-weight","normal"),p.li.attr("data-role","list-item"),l.push(p.li[0])}}),f.append(l),this},m._updateSelectAll=function(){if(this.$selectAll){var a=this.getSelectedValues(),b=this.getListItems();this.$selectAll.prop("checked",a.length==b.length)}return this},m.enable=function(b){this.$filterInput.prop("disabled",!b),a.each(this.controlsByValue,function(a,c){c.checkbox.prop("disabled",!b)})},m.updateUserMessage=function(b,c){this.$userMessage||(this.$userMessage=a("<div>").insertAfter(this.$filterContainer)),this.$userMessage.text(b),c?this.$userMessage.addClass("alert-warning"):this.$userMessage.removeClass("alert-warning")},m.selectItems=function(b,c,e,f){b||(b=this._getValues(j.States.Visible));var g=this.controlsByValue;return a.each(b,function(b,e){var h=null;if(e=d.decodeHtml(e),g[e]&&(h=g[e].checkbox),h&&f&&f.parentInfoMap){var i=f.parentInfoMap[j.getParentProjectName(h)]&&-1!==f.parentInfoMap[j.getParentProjectName(h)].indexOf(a(h).val());(i||"Unassigned"===a(h).val()&&f.selectUnassigned)&&h.prop("checked",c)}else h&&h.prop("checked",c)}),e&&this.notify(j.Events.itemSelected,{}),this},m.showSubtypeAttributes=function(b){var c=this._getValues(j.States.All),e=this.controlsByValue;a.each(c,function(a,c){if(c=d.decodeHtml(c),e[c]){const f=e[c],g=f.li,h=f.option.attr("data-keeplocal");"true"===h&&(b?g.show():g.hide())}})},m.getSelectedValues=function(){if(!this.multiSelect){var b=this.$list.find('> li input[name="'+this.inputName+'"]:checked').val();return null===b||void 0===b?[]:[b]}return a.map(this.$list.find("> li input:checked"),function(b){if("none"!==a(b).css("display")){var c=a(b);return c.val()}})},m.getControlsByValueMap=function(){return this.controlsByValue},m.getAllValues=function(){return a.map(this.$list.find("> li input"),function(b){return a(b).val()})},m.showSelectedInView=function(){var b=this.$list.find("> li input:checked");b.each(function(){var b=this;setTimeout(function(){a(b).parent().parent()[0].scrollIntoView()},500)})},m.getSelectedTexts=function(){var b=this.controlsByValue;return a.map(this.$list.find("> li input:checked"),function(c){var d=a(c).val();return b[d]&&"none"!==a(c).css("display")?b[d].option.text().trim():null})},m.getTextsByValues=function(b){var c=this.controlsByValue;return a.map(b,function(a){return c[a]?c[a].option.text().trim():null})},m.getListItems=function(b){b=b||j.States.All;var c=this._getValues(b),d=this.controlsByValue;return a.map(c,function(a){return d[a]&&"none"!==d[a].li.css("display")?d[a].li:null})},m.getOptions=function(b,c){var d=this._getValues(b),e=this.controlsByValue;return a.map(d,function(a){return e[a]?e[a].option:null})},m.getOptionStrings=function(b){var c=this._getValues(b),e=this.controlsByValue;return a.map(c,function(a){return e[a]?'<option value="'+d.encodeHtml(a)+'">'+d.encodeHtml(e[a].option.text().trim())+"</option>":null})},m._getOptions=function(){var b=this.options.hideDerived,c=this.$select.find("option").filter(function(){return 1==a(this).data("ignore")||b&&1==a(this).data("derived")?!1:!0});return c},m._selectOptions=function(b){var c=this._getOptions();return b&&c.sort(function(b,c){var d=a(b).text(),e=a(c).text();return d.localeCompare(e)}),c},m._getValues=function(b){var c=this._getOptions(),d=this,e=c.map(function(){return d._getOptionValue(a(this))});if(b===j.States.All)return e;var f=this.controlsByValue;return b===j.States.Selected?this.getSelectedValues():e.filter(function(a){var c="none"!==f[this].li.css("display");return b===j.States.Visible?c:!c})},m.refresh=function(){return this.$list.empty(),this.$selectAllContainer&&this.$selectAllContainer.remove(),this.$filterSubtypesContainer&&this.$filterSubtypesContainer.remove(),this._fillItemList(),this.clearFilterInput(),this.options.showSubtypesButton?window.localStorage.IncludeAttributesFromSubtypesCheckState?"false"===window.localStorage.IncludeAttributesFromSubtypesCheckState&&this.$filterSubItems.trigger("click"):window.localStorage.IncludeAttributesFromSubtypesCheckState=!0:(this.showSubtypeAttributes(!1),window.localStorage.removeItem("IncludeAttributesFromSubtypesCheckState")),this},m._highlight=function(b){var c=a.map(this.getListItems(),function(a){return a.find("span.label-text")});a(c).highlight(d.encodeHtml(b),"filter-highlight-text")},m._scrollTo=function(a,b){b.scrollTop(a.offset().top)},m._getOptionValue=function(a){var b=this.options.optionValueAttrName;return b?a.attr(b):a.val()};var n="jrs.filter.select";return j.getParentProjectName=function(b){var c=a(b).closest(".tree-select").prev();if(0!=c.length){var d=c.attr("data-altvalue");return d?d:d=this.getParentProjectName(c)}},j.getInstance=function(a){return a.data(n)},j.States={Hidden:0,Visible:1,Selected:2,All:3},j.Events={beforeSelectAll:"select-filter-before-select-all",afterSelectAll:"select-filter-after-select-all",itemSelected:"select-filter-item-selected",search:"select-filter-search"},j.DEFAULT_OPTIONS={sortItems:!1},a.fn.filterSelect=function(b){var c=j.getInstance(a(this));return c&&c.$select.parent().children()[1]&&c.$select.parent().children()[1].childNodes[1]&&this.parent().children()[1]&&this.parent().children()[1].childNodes[1]&&c.$select.parent().children()[1].childNodes[1].innerHTML===this.parent().children()[1].childNodes[1].innerHTML?c:(c=new j(b,this[0]),a(this).data(n,c),c)},j});