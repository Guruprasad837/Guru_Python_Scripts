/*******************************************************************************
 * Licensed Materials - Property of IBM
 * Â© Copyright IBM Corporation 2013, 2024 All Rights Reserved.
 * 
 * Note to U.S. Government Users Restricted Rights:
 * Use, duplication or disclosure restricted by GSA ADP Schedule
 * Contract with IBM Corp.
 *******************************************************************************/
define(["chart/chartBase","common/htmlUtils","moment-with-langs.min"],function(a,b,c){var d=function(b,d){d.locale&&1!=c&&c.lang(d.locale.substring(0,-1==d.locale.indexOf("_")?d.locale.length:d.locale.indexOf("_"))),d.isTimeSeries=d.preview?!1:d.isTimeSeries,d.side=d.side===!0||"true"==d.side?!0:!1,d.side&&(d.legendOrientation="bottom"),a.apply(this,arguments)};return SUBCLASS_FROM(d,a),d.prototype.transformData=function(b){if(b.chartData.data.length>0&&b.isTimeSeries){b.chartData.origData?b.chartData.data=a.cloneObject(b.chartData.origData):b.chartData.origData=a.cloneObject(b.chartData.data);var d;if(b.chartData.data.length>0){var e=b.chartData.data[0];for(var f in e.drilldown)if(f&&e.drilldown[f]&&b.chartData.group&&e.drilldown[f][b.chartData.group]){if(b.chartData.series.length>0){for(var g=[],h=0;h<b.chartData.series.length;h++)g.push(this._htmlDecode(b.chartData.series[h].varName));var i=[],j=e.drilldown[f];for(var k in j)if(k!==b.chartData.group&&0!==k.indexOf("__")){var l=j[k];-1===g.indexOf(l)&&i.push(k)}1===i.length&&(d=i[0],b.chartData.singleAttributeUnit=d);break}break}}var m=this,n=function(a,b){var d=c(m._htmlDecode(a.label)),e=c(m._htmlDecode(b.label));return d&&e&&d.isBefore(e)?-1:1};if(b.chartData.data.sort(n),b.chartData.data.length>1){for(var o=[],p=0,q=null,h=0;h<b.chartData.data.length-1;h++){var r=b.chartData.data[h],s=b.chartData.data[h+1],t=c(m._htmlDecode(r.label)),u=c(m._htmlDecode(s.label));if(o[p++]=r,t&&u)for(;t.clone().add("days",1).startOf("day").isBefore(u.startOf("day"));)if(t=t.add("days",1).startOf("day"),!t.isSame(u.startOf("day"))){for(var l=[],v=0;v<b.chartData.series.length;v++)if(b.noValZero){var w=c().format("YYYY-MM-DDTHH:mm:ss.S"),x=c(m._htmlDecode(w));x&&t&&(t.isBefore(x)||t.isSame(x))?l.push(0):l.push(null)}else l.push(null);var y={label:t.format("YYYY-MM-DD").concat("Z"),value:l};o[p++]=y}q=s}o[p++]=q,b.chartData.data=o}for(var z=[],A=null,B=[],p=0;p<b.chartData.series.length;p++)B.push(void 0);for(var C=function(a,b,d){var e=c(a),f=c(b),g=void 0;d>0?g=e.subtract:0>d&&(g=e.add,d=-1*d);var h=(g?g.call(e,d,"days"):e).format("YYYY-MM-DD"),i=(g?g.call(f,d,"days"):f).format("YYYY-MM-DD"),j=[];return j.push("__daterangeParm__"+h),j.push(i),j},D=function(a,e){if(e){if(e.value){for(var f=0;f<e.value.length;f++){var g=b.seriesLabel?b.seriesLabel[f].calc:b.calcs.replace("[","").replace("]","");if("avg"==g&&e.value[f]&&void 0!==a[f])e.value[f]=Math.round(100*(e.value[f]/(a[f]+1)))/100;else if(null===e.value[f]&&b.noValZero){var h=c().format("MM/DD/YYYY"),i=c(m._htmlDecode(h)),j=c(m._htmlDecode(e.label));i&&j&&(j.isBefore(i)||j.isSame(i))&&(e.value[f]=0)}else"sum"==g&&e.value[f]&&(e.value[f]=Math.round(100*e.value[f])/100)}z.push(e)}if(e.drilldown&&"Days"===b.dateScale&&e.startLabelAsDate&&(e.endLabelAsDate=e.startLabelAsDate),e.endLabelAsDate&&e.drilldown)for(var k=c(e.startLabelAsDate).format("YYYY-MM-DD"),l=c(e.endLabelAsDate).format("YYYY-MM-DD"),f=0;f<b.chartData.series.length;f++){var n=m._htmlDecode(b.chartData.series[f].varName),o=e.drilldown[n],p=[];if(p.push("__daterangeParm__"+k),p.push(l),o){if(b.chartData.series[f]&&b.chartData.series[f].varName&&e.drilldownDate&&e.drilldownDate[m._htmlDecode(b.chartData.series[f].varName)]&&(p=e.drilldownDate[m._htmlDecode(b.chartData.series[f].varName)]),e.drilldown[n][b.chartData.group]=p,e.value[f]&&d&&e.drilldown[n][d]){var q=e.drilldown[n].__relativeDateDaysBefore__;q&&q[d]&&(e.drilldown[n][d]=C(e.startLabelAsDate,e.endLabelAsDate,q[d]))}}else for(var r in e.drilldown){var s=e.drilldown[r][n];if(s&&s instanceof Array&&2==s.length){if(0==s[0].indexOf("__daterangeParm")){var q=e.drilldown[r].__relativeDateDaysBefore__;q&&q[n]?e.drilldown[r][n]=C(e.startLabelAsDate,e.endLabelAsDate,q[n]):e.drilldown[r][n]=p}}else e.value[f]&&b.chartData.group&&e.drilldown[r][b.chartData.group]&&(e.drilldown[r][b.chartData.group]=p)}}}},h=0,E=b.chartData.data.length;E>h;h++){var e=b.chartData.data[h],F=e.label?c(this._htmlDecode(e.label)):null;if(!F||F.isValid()){var y=null,G=A?this.formatForDateScale(b,A.labelAsDate).label:null,H=this.formatForDateScale(b,F),I=H.label;if(G==I){y=A;for(var p=0;p<e.value.length;p++){var J=b.seriesLabel?b.seriesLabel[p].calc:b.calcs.replace("[","").replace("]",""),K=null!==e.value[p]?parseFloat(e.value[p]):null;m.isGoalLine(b,p)?y.value[p]||null!==K&&(y.value[p]=K):"sum"==J?null!==K&&0!==K&&(y.value[p]+=K):"avg"==J?(null!==K&&0!==K&&(y.value[p]+=K),void 0!==B[p]?B[p]++:B[p]=0):"first"==J?y.value[p]||null!==K&&0!==K&&(y.value[p]=K,y.drilldownDate||(y.drilldownDate={}),y.drilldownDate[m._htmlDecode(b.chartData.series[p].varName)]||(y.drilldownDate[m._htmlDecode(b.chartData.series[p].varName)]=e.label)):"last"==J&&null!==K&&(y.value[p]=K,0!=K&&(y.drilldownDate||(y.drilldownDate={}),b.chartData.series[p]&&b.chartData.series[p].varName&&(y.drilldownDate[m._htmlDecode(b.chartData.series[p].varName)]=e.label)))}y.endLabelAsDate=F.clone();for(var f in e.drilldown)y.drilldown||(y.drilldown={}),y.drilldown[f]=e.drilldown[f]}else{D(B,A),y={href:e.hef,label:H.label,drilldown:e.drilldown,startLabelAsDate:F,labelAsDate:b.dateScale?H.date:F,value:[]};for(var p=0;p<e.value.length;p++)if(y.value[p]=null!==e.value[p]?parseFloat(e.value[p]):null,null!==y.value[p]&&0!==y.value[p]){B[p]=0;var J=b.seriesLabel?b.seriesLabel[p].calc:b.calcs.replace("[","").replace("]","");("first"===J||"last"===J)&&(y.drilldownDate||(y.drilldownDate={}),y.drilldownDate[m._htmlDecode(b.chartData.series[p].varName)]||(y.drilldownDate[m._htmlDecode(b.chartData.series[p].varName)]=e.label))}else B[p]=void 0}A=y}}for(var h=0,E=b.chartData.data.length;E>h;h++)for(var e=b.chartData.data[h],p=0;p<e.value.length;p++){var K=e.value[p];"nil"===K&&(e.value[p]=null)}D(B,A);var L={};EXTEND(L,b.chartData),L.data=z,b.chartData=L}a.prototype.transformData(b)},d.prototype.formatForDateScale=function(a,b,d){if(!b)return{label:a.unassignedMsg,date:null};var e="L",f=c(b).clone(),g=b,h=d?d:a.dateScale;"Weeks"==h?g=f.endOf("week"):"Months"==h?(e="MMMM YYYY",g=f.endOf("month")):"Years"==h&&(e="YYYY",g=f.endOf("year"));var i=c(g).format(e);return{label:i,date:g}},d.prototype._calculateTextWidth=function(a){this.svgContainer.append("text").attr("x",-100).attr("y",-100).text(a);var b=this.svgContainer.select("text"),c=0;try{c=b.node().getComputedTextLength()}catch(d){c=b.node().getBBox().width}return b.remove(),c},d.prototype.getMargin=function(c){var d=a.prototype.getMargin(c);if(d.top=c.side?c.groupTitle?20:d.top:c.countTitle?20:d.top,d.bottom=c.side?c.countTitle?35:20:c.groupTitle?35:20,this.maxLabelLength=this.getMaxLabelLength(c),c.side){var e=Math.min(15,Math.max(c.groupTitle?b.fullWidthLength(c.groupTitle):d.left/10,this.maxLabelLength));d.left=9*e}else{var f=this,g=Math.min(d3.max(c.chartData.data,function(a){return d3.max(a.value,function(a){return null!=a?f._calculateTextWidth(a)+1:0})}));isNaN(g)&&(g=1),d.left=g+40}return d.right+=2,d},d.prototype.getMaxLabelLength=function(a){var c=a.chartData.data;if(!a.isTimeSeries)return d3.max(c,function(a){return b.fullWidthLength(a.label)});var d=this;return d3.max(c,function(b){return d.formatForDateScale(a,b.labelAsDate).label.length})},d.MAX_TEXT_WIDTH=150,d.prototype._getAverageCharWidth=function(a){try{textlg=a.getComputedTextLength()}catch(b){return}var c=a.getNumberOfChars();return textlg/c},d.prototype.doGroupScale=function(a,b,c,e,f,g,h){function i(a){var b=[];for(var c in a)b=b.concat(a[c]);return b}var j=d3.scale.ordinal().rangeBands([0,e],f),k=this;c.chartData.negativeValues&&b.length>0&&b[0].constructor===Array?j.domain(i(b.map(function(a){return a.map(PROXY(function(a){if(c.isTimeSeries)return k.formatForDateScale(c,a.labelAsDate).label;if(""===a.label&&c.unassignedMsg)return c.unassignedMsg;if(-1!=a.label.indexOf("%2c")){var b=new RegExp("%2c","g");a.label=a.label.replace(b,",")}return a.label},this))}))):j.domain(b.map(PROXY(function(a){if(c.isTimeSeries)return k.formatForDateScale(c,a.labelAsDate).label;if(""===a.label&&c.unassignedMsg)return c.unassignedMsg;if(-1!=a.label.indexOf("%2c")){var b=new RegExp("%2c","g");a.label=a.label.replace(b,",")}return a.label}),this));var l=d3.svg.axis().scale(j).orient(g?"left":"bottom");c.preview&&l.tickSize(0);var m=a.append("g");m.attr("class",g?"y axis":"x axis").attr("transform",g?"translate(0, 0)":"translate(0,"+h.height+")").call(l);var n;if(g&&c.groupTitle){var o=a.append("text");o.attr("transform","translate(-10 ,0)").style("text-anchor","end").style("font-size",(this.fontSize>12?this.fontSize:12)+"px").text(this._htmlDecode(c.groupTitle)),n=this.trimTextToContainer(o[0][0],d.MAX_TEXT_WIDTH),c.preview||c.fullPreview||o.on("mouseover",PROXY(function(a){this._showTooltip({label:this._htmlDecode(c.groupTitle)},d3.event)},this)).on("mousemove",PROXY(function(a){this._showTooltip({label:this._htmlDecode(c.groupTitle)},d3.event)},this)).on("mouseout",PROXY(function(a){this._hideTooltip()},this))}var p={};if(c.chartData.negativeValues&&b.length>0&&b[0].constructor===Array)for(var q=0;q<b.length;q++)for(var r=0,s=b[q].length;s>r;r++)p[b[q][r].label]=b[q][r].href;else for(var r=0,s=b.length;s>r;r++)p[b[r].label]=b[r].href;var t=!1,u=m.selectAll("text");if(!g){var v=u[0].length,w=(h.width-j.rangeBand()*v)/(v+1)-4;n=j.rangeBand()+Math.max(0,w);for(var x=n,r=0,s=u[0].length;s>r;r++)if(this.shouldTrimTextToContainer(u[0][r],n)){t=!0;break}}var k=this;if(u.call(function(a){if(this.length>0)for(var b=0,c=this[0].length;c>b;b++){var e=k.trimTextToContainer(this[0][b],d.MAX_TEXT_WIDTH);e>n&&(n=e)}}).on("click",PROXY(function(a,b){var c=p[a];c&&c.length>0&&window.open(c)},this)).on("mouseover",PROXY(function(a){c.preview||this._showTooltip(a,d3.event)},this)).on("mousemove",PROXY(function(a){c.preview||this._showTooltip(a,d3.event)},this)).on("mouseout",PROXY(function(a){this._hideTooltip()},this)),u.each(function(a,b){var e=d3.select(this);e.text(k._htmlDecode(e.text()));var f=p[a],g="";if(c&&-1!=c.type.indexOf("barchart")&&b<c.chartData.data.length&&"png"==c.chart_export_type&&(g="text-axis "),c&&"barchart"===c.type&&b<c.chartData.data.length&&d._isSecondYAxis(c.chartData.data[b].graphYAxis)){var h=document.getElementsByClassName("legend-text2");if(h&&h.length>0){var i=window.getComputedStyle(h[0]),j=i.getPropertyValue("fill");j&&e.style("fill",j)}}f?e.attr("class",g+"text-link"):e.attr("class",g+"text-no-link")}),t&&(h.extraHeight=n/Math.sqrt(2),h.extraWidth=h.extraHeight-x+50,u.style("text-anchor","start").attr("dx","1.0em").attr("dy","0.5em").attr("transform",function(a){return"rotate(45)"})),!g&&c.groupTitle){var y=this._htmlDecode(c.groupTitle),z=y;if(z.length>100&&(z=z.substring(0,97)+"..."),-1!=z.indexOf("%2c")){var A=new RegExp("%2c","g");z=z.replace(A,",")}var o=a.append("text").attr("transform","translate("+h.width/2+" ,"+(h.height+h.bottomChart-5+h.extraHeight+20)+")").attr("class","text-no-link").style("text-anchor","middle").style("font-size",(this.fontSize>12?this.fontSize:12)+"px").text(z);!c.preview&&!c.fullPreview&&y.length>z.length&&o.on("mouseover",PROXY(function(a){this._showTooltip({label:y},d3.event)},this)).on("mousemove",PROXY(function(a){this._showTooltip({label:y},d3.event)},this)).on("mouseout",PROXY(function(a){this._hideTooltip()},this))}return g&&c.groupTitle&&(n+=10,this.sideChart=n+20,h.extraWidth+=n-h.margin.left,c&&-1!=c.type.indexOf("barchart")?a.attr("transform","translate("+(n+25)+","+h.margin.top+")"):a.attr("transform","translate("+n+","+h.margin.top+")")),j},d.prototype.doValueScale=function(a,b,c,e,f,g,h,i){var j=d3.scale.linear().rangeRound(e?[0,c]:[c,0]);if(!i&&b.chartData.negativeValues){i=0;for(var k=0;k<b.chartData.data.length;k++)for(var l=b.chartData.data[k].value,m=0;m<l.length;m++){var n=l[m];null!=n&&void 0!==n&&(n=parseInt(Math.ceil(n)),i>n&&(i=n))}}if(!f&&(f=0,g=0,b.chartData.series&&b.chartData.series.length>0&&b.chartData.data.length>0&&b.chartData.data[0].value&&b.chartData.data[0].value.length===b.chartData.series.length)){if(1===b.chartData.series.length&&""===b.chartData.series[0].varName){for(var o=b.chartData.data,p="linechart"!==b.type,k=0;k<o.length;k++)if(o[k].value&&1===o[k].value.length){var n=parseInt(Math.ceil(o[k].value));d._isSecondYAxis(o[k].graphYAxis)&&p?n>g&&(g=n):n>f&&(f=n)}}else{for(var q=[],k=0;k<b.chartData.series.length;k++){var r=b.chartData.series[k].graphYAxis;d._isSecondYAxis(r)&&h&&q.push(k)}for(var k=0;k<b.chartData.data.length;k++)for(var l=b.chartData.data[k].value,m=0;m<l.length;m++){var n=l[m];null!=n&&void 0!==n&&(n=parseInt(Math.ceil(n)),-1===q.indexOf(m)?n>f&&(f=n):n>g&&(g=n))}}g=Math.ceil(1.2*g)}var s=d3.svg.axis().tickFormat(d3.format("d")).scale(j).orient(e?"bottom":"left");if(b.chartData.negativeValues){var t=0;t=Math.abs(i)>Math.abs(f)?Math.abs(i)/10:Math.abs(f)/10,j.domain([i-t,f+t])}else j.domain([0,f+f/10]);b.detail||s.tickValues([0,f]),b.preview&&s.tickSize(0);var u=a.append("g").attr("class",e?"x axis":"y axis").attr("transform",e?"translate(0,"+this.height+")":"translate(0 ,0)").call(s);if(g){var v=d3.scale.linear().rangeRound(e?[0,c]:[c,0]);v.domain([0,g]);var w=d3.svg.axis().tickFormat(d3.format("d")).scale(v).orient(e?"top":"right");a.append("g").attr("class",e?"x axis2":"y axis2").attr("transform",e?"translate(0, 0)":"translate("+this.width+" , 0)").call(w);h&&h.push(v)}var x=0,y=u.selectAll("text"),z=!1;if(e)for(var k=(y[0].length,0),A=y[0].length;A>k;k++){var B=y[0][k].textContent;if(void 0!=B&&B.length>4){z=!0;break}}y.each(function(a,c){var d=d3.select(this);"png"==b.chart_export_type&&d.attr("class","text-axis")});var C=this;if(y.call(function(a){if(this.length>0)for(var b=0,c=this[0].length;c>b;b++){var e=C.trimTextToContainer(this[0][b],d.MAX_TEXT_WIDTH);e>x&&(x=e)}}),x+10>this.margin.left&&(x+=10,this.sideChart=this.margin.left+10,this.extraWidth+=x-this.margin.left,a.attr("transform","translate("+(this.margin.left+20)+","+this.margin.top+")")),z&&(this.extraHeight=x/Math.sqrt(2),y.style("text-anchor","start").attr("dx","1.0em").attr("dy","0.5em").attr("transform",function(a){return"rotate(45)"})),b.countTitle||b.seriesLabel&&b.seriesLabel.length&&!b.countTitle){var D=a.append("text"),E=b.countTitle?b.countTitle:1==b.seriesLabel.length?b.seriesLabel[0].label:"";if(E&&-1!=E.indexOf("%2c")){var F=new RegExp("%2c","g");E=E.replace(F,",")}if(D.attr("transform",e?"translate("+(b.width-this.margin.left)/2+" ,"+(this.height+this.bottomChart-5+this.extraHeight+20)+")":"rotate(-90)").attr("y",e?0:0-this.margin.left+10).attr("x",e?0:0-this.height/2).style("text-anchor","middle").style("font-size",(this.fontSize>12?this.fontSize:12)+"px").text(this._htmlDecode(E)),this.margin){var G=e?b.width-this.margin.left:this.height-this.margin.top;if(this.shouldTrimTextToContainer(D[0][0],G)){var H=this.trimTextToContainer(D[0][0],G);H>x&&(x=H),D.on("mouseover",PROXY(function(a){b.preview||this._showTooltip({label:this._htmlDecode(E)},d3.event)},this)).on("mousemove",PROXY(function(a){b.preview||this._showTooltip({label:this._htmlDecode(E)},d3.event)},this)).on("mouseout",PROXY(function(a){this._hideTooltip()},this))}}}return j},d.prototype.doGrid=function(a,b,c,d){a.append("g").attr("class","grid").call(d3.svg.axis().scale(b).orient(c).tickSize(d,0,0).tickFormat(""))},d.prototype.putMessagePlaceHolder=function(a){a.append("g").attr("class","message")},d.prototype.doChart=function(a,b){if(b.noDataMessage){d.prototype.doGroupScale.call(this,a,b.chartData.data,b,this.width,1,!1,this);var c=d.prototype.doValueScale.call(this,a,b,this.height,!1);return b.showGrids&&this.doGrid(a,c,"left",-this.width),void this.putMessagePlaceHolder(a)}},d.prototype.getTooltipLabel=function(a,b){if("string"==typeof a)return a;if(""===a.label&&b.unassignedMsg)return b.unassignedMsg;var c=a.labelAsDate?this.formatForDateScale(b,a.labelAsDate).label:a.label;return c},d.prototype.doDrillDown=function(a,b,c,d){if(window.___onDrilldown){var e=a.chartData.data[c];e.seriesIdx>=0?(d=e.seriesIdx,c=e.categoryIdx,window.___onDrilldown(a,chartData,b,c,d,!1,a.dateScale)):window.___onDrilldown(a,a.chartData,b,c,d,a.dateScale&&"Days"!=a.dateScale,a.dateScale)}},d.prototype.doBars=function(a,b,c,d,e,f,g){var h=window.___hasDrilldown&&window.___hasDrilldown(b.chartData)?"bar":"bar-no-link";a.selectAll("."+h).data(c).enter().append("rect").attr("class",function(a){var c=a.sectionLabel;if(void 0==c)return h;for(var d=0,e=0;e<b.chartData.series.length;e++)if(a.sectionLabel&&a.sectionLabel===b.chartData.series[e].label&&d++,0!=d){var f=b.chartData.series[e],g=f?f.subreport:null;return g?"bar":"bar-no-link"}}).attr("width",d).attr("height",PROXY(e,this)).attr("x",f).attr("y",g).style("fill",function(a){var b=a.colour;return d3.rgb(b.r,b.g,b.b)}).style("stroke",function(a){var b=a.colour;return d3.rgb(b.r,b.g,b.b).darker()}).style("stroke-width",1).on("click",PROXY(function(a,c,d){this.doDrillDown(b,a,c,d)},this)).on("mouseover",PROXY(function(a){b.preview||(this._showTooltip(a,d3.event,b),d3.event&&d3.select(d3.event.currentTarget).style("fill",function(){var b=a.colour;return d3.rgb(255-b.r,255-b.g,255-b.b)}))},this)).on("mousemove",PROXY(function(a){b.preview||this._showTooltip(a,d3.event,b)},this)).on("mouseout",PROXY(function(a){this._hideTooltip(),d3.event&&d3.select(d3.event.currentTarget).style("fill",function(){var b=a.colour;return d3.rgb(b.r,b.g,b.b)})},this)),"barchart"==b.type||"groupedbarchart"==b.type?this.doValueText(b,c,a,d,e,f,g,function(a){return 0!=a.value?a.value<1e3?a.value:d3.format(".3s")(a.value):""},!0,"chart-text-value-black"):this.doValueText(b,c,a,d,e,f,g)},d.prototype.doValueText=function(a,b,c,d,e,f,g,h,i,j){if(!a.preview&&a.showValues){var k=c.selectAll("."+(j?j:"chart-text-value")).data(b).enter().append("text").attr("class",j?j:"chart-text-value");(0==k.size()||k[0].constructor===Array&&null==k[0][0])&&(k=c.selectAll(".chart-text-value").data(b).enter().append("text").attr("class",j?j:"chart-text-value"));var l=PROXY(e,this),m=!1,n=0;do m=!1,("barchart"==a.type||"groupedbarchart"==a.type)&&a.side&&i?k.attr("dy",".35em").text(function(a){return h?h(a):0!=a.value?a.value:""}):k.attr("dy",".35em").style("text-anchor","middle").text(function(a){return h?h(a):0!=a.value?a.value:""}),k.attr("x",function(b,c,e){return i&&a.side?f(b,c,e)+d(b)+4:f(b,c,e)+d(b)/2}).attr("y",function(b,c,d){var e=d3.select(this).node().getBBox(),f=e.height,h=(l(b)-f)/2;h>f/2&&(h=f/2);var j=f/2+h,k=g(b,c,d);return i&&"groupedbarchart"==a.type&&b.value<0?k+l(b)+10:i&&!a.side?k-10:i&&"groupedbarchart"==a.type&&"bottom"==a.legendOrientation?k-j+8:"stackedbarchart"==a.type&&-1!==a.seriesTypes.indexOf("line")&&"bottom"==a.legendOrientation?k-j+25:"stackedbarchart"==a.type&&-1!==a.seriesTypes.indexOf("line")?k+l(b)/2:a.side?k+l(b)/2:k+j}).text(function(b){if(0!=b.value){var c=d3.select(this).node().getBBox();if("svg"==a.chart_export_type||"png"==a.chart_export_type){var e={height:1,width:12};this.style["text-shadow"]="1px 1px 1px black"}var f=2,g=this.style["font-size"],i=g?parseInt(g.substring(0,g.length-2)):14;f=i>=14?2:i>=10?1:0;var k=l(b)-f,n=d(b)-f;return j||Math.floor(c.height-(e?e.height:0))<=Math.ceil(k)&&Math.floor(c.width-(e?e.width:0))<=Math.ceil(n)?h?h(b):b.value:(this.style["font-size"]=--i+"px",!m&&i>=5&&(m=!0),"")}}),n++;while(m=10>n)}},d.prototype.drawLine=function(a,b,c,d,e,f,g,h,i,j){var k=0,l=0;j&&(k=a.side?0:h.rangeBand()/2,l=a.side?i.rangeBand()/2:0);var m=function(b){var d=h(a.side?b.value[c]:a.isTimeSeries?b.labelAsDate:b.label?b.label:a.unassignedMsg);return(isNaN(d)?0:d)+k},n=function(b){var d=i(a.side?a.isTimeSeries?b.labelAsDate:b.label:b.value[c]);return(isNaN(d)?0:d)+l},o=d3.svg.line().x(m).y(n),p=g.append("svg:path").attr("class","path").attr("d",o(b)).style("stroke",function(){var a=d;return d3.rgb(a.r,a.g,a.b)}).style("stroke-width",e).style("stroke-dasharray",f?"5, 5":void 0);this.isGoalLine(a,c)&&p.datum(c);var q=20;this.doValueText(a,b,g,function(){return q},n,function(a){return m(a)-q/2},n,function(a){return a.value[c]},!0,"chart-line-text-value")},d.prototype.isGoalLine=function(a,b){var c=a.chartData.series[b].varName;return c&&0==c.indexOf("__GL__")?!0:!1},d._isSecondYAxis=function(b){return a._isSecondYAxis(b)},d});