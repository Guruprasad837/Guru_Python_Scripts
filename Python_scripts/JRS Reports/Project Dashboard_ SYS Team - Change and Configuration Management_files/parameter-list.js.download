/*******************************************************************************
 * Licensed Materials - Property of IBM
 * Â© Copyright IBM Corporation 2014, 2023. All Rights Reserved.
 * 
 * Note to U.S. Government Users Restricted Rights:
 * Use, duplication or disclosure restricted by GSA ADP Schedule
 * Contract with IBM Corp.
 *******************************************************************************/
define(["./report-parameter","./query-kind","./text-kind","./boolean-kind","./date-kind","./date-range-kind","./configuration-kind","common/ordered-set","common/templates","i18n!nls/messages","queries/vocabularies","common/customEvents","common/htmlUtils","common/tooltipUtils"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(){var a=u++;return"seq-id-"+a}function p(a){l.install(this),new i,this._options=$.extend({},v,a||{}),this.$container=$(this._options.containerId),this._filterCollection=new h,this._columnCollection=new h,this._reportParams={},this._reconfigure=!1}function q(a){try{for(var b=__reportQBO.QueryBuilder.topFilterGroup.columnFilters,c=0;c<b.length;c++){var d=b[c].filter;if(d.runtimeVar===a)return d}}catch(e){}return{}}function r(){$("#_paramsSaveButton").trigger("click")}var s=k.SR,t={};t[s.uQueryKind]=b,t[s.uMetamodelKind]=b,t[s.uTextKind]=c,t[s.uBooleanKind]=d,t[s.uDateKind]=e,t[s.uDateRangeKind]=f;var u=0,v={containerId:"#parameters-content",gutter:-1,itemsPerRow:3};p.prototype.setReportQBO=function(a){if(!this._filters&&a&&a.QueryBuilder&&a.QueryBuilder.topFilterGroup){var b=a.QueryBuilder.topFilterGroup.group;b&&b.filtersAndGroups&&(this._filters=[],this.collectFilters(b.filtersAndGroups,this._filters))}},p.prototype.columnFiltersAsGraph=function(a){var b=this;this.each(function(c,d){if(c.columnId){c.showAsInline(!a);var e=c.widget();a?e.appendTo(b.$container).removeClass("inline-filter").show().find(".run-filter-links").hide():e.appendTo($("body")).addClass("inline-filter").hide().find(".run-filter-links").show()}})},p.prototype.createParam=function(d){d.parameterQuery||d.parameterQuery_&&(d.parameterQuery=d.parameterQuery_),this.notify(p.Events.CreatingFilter,{param:d});var e=d.parameterKind,f=t[e];if(!f)return alert(e+": Not implemented"),null;f==b&&d.reportQueryVariableKind==s.uConfigurationPickerKind&&(f=g);var h=void 0;d.dependsOnParameter&&(h=this.getFilter(d.dependsOnParameter));var i=f({rptParam:d,gadget:this._options.gadget,inlineRun:this._options.inlineRun,parentFilter:h});if(null!==i){if(f==c&&l.install(i),this.addFilter(d,i.start(this._options)),i.isRequired()&&(this.hasRequiredFilters=!0),d.reportQueryVariable){var j=d.reportQueryVariable;if(this._filters&&this._filters.length)for(var k=0;k<this._filters.length;k++){var m=this._filters[k];if(j===m.runtimeVar&&!i.hideFilterOp){i.setFilterOperator(m.operator);break}}}return this.notify(p.Events.FilterCreated,{param:d,filter:i}),f==c&&i.notify(a.Events.FilterCreated),i}};var w=[];return p.prototype.__merge_filters=function(a,b){var c=this._columnCollection.get(a);if(c){var d=c.widget();d.addClass("filter-combined"),b.widget().children().appendTo(d),c.merged=c.merged||[],c.merged.push(b)}},p.prototype.addFilter=function(a,b){var c=a["@id"];c||(c=o()),b.id=c;var d=q(a.reportQueryVariable),e=d.variableName;if(e){b.columnId=e,b.originalTitle=b.title(),b.inlineTitle=d.domainLabel,b.title(b.inlineTitle||"");var f=this.mergedColumns[e],g=""!==f;if(g){b.isMerged=!0;var h=this._columnCollection.get(f);h?this.__merge_filters(f,b):w.push({main:f,filter:b})}else b.widget().addClass("inline-filter").appendTo("body").hide(),this._columnCollection.add(e,b)}else this.hasDynamicFilters=!0;return this._filterCollection.add(c,b),this._reportParams[c]=a,this.layout(),b.finalize("filter-"+this._filterCollection.length()),b},p.prototype.hideFilters=function(a){a=a||$(".inline-filter-open"),a.map(function(){return $(this).removeClass("inline-filter-open"),$(this).parent()}).each(function(){var a=$(this).data("column-filter-object"),b=a.widget();b.hide(),a.$filterToggle.collapse("hide")}),this.updateColumnStates()},p.prototype.applyColumnFilters=function(){function a(a,b){a.popover({container:"body",delay:{show:500,hide:50},placement:"top auto",trigger:"hover",html:!0,content:b})}function b(a){a.popover("hide")}var c=240,d=480;this.each(function(a,b){a.showDisplayValues()});var e=this;$("th[data-resizable-column-id!=''][data-resizable-column-id]").each(function(){function f(a){var b=j.filters();return function(){function c(){for(var a=j.widget(),c=a.find(".jrs-param-title"),d=j.getRunValues(),d=$.map(b,function(a){return a.getRunValues()}),e=[],f=0;f<c.length;f++)e.push("<strong>"+$(c[f]).html()+"</strong><div style='text-overflow:ellipsis;overflow: hidden;'>"+d[f]+"</div><br>");return e.join("<br>")}var d=[];if(b.forEach(function(a){a.runQuery&&!a.areValuesLoaded()&&d.push(a)}),!(d.length>0))return c();var e=0;d.forEach(function(b){b.runQuery(function(){e++,e===d.length&&a.trigger("mouseover")})})}}var g=$(this),h=g.find("span.column-filter"),i=h.data("column-id"),j=e._columnCollection.get(i);if(void 0===j)h.remove();else{j.$hdrEdit=h;var k=j.merged||[];k.forEach(function(a){a.$hdrEdit=h}),g.data("column-filter-object",j),h.off("click").click(function(a){b($(this));var f=e._columnCollection.get(i),h=f.widget();if(h.is(":visible"))e.hideFilters($(this));else{e.hideFilters(),$(this).addClass("inline-filter-open");var j=g[0].getBoundingClientRect(),k={left:g.offset().left,top:g.offset().top+j.height};k.width=j.width,k.width<c&&(k.width=c),k.width>d&&(k.width=d),h.css(k),h.css({display:"block"});var l=window.innerWidth;if(k.left+k.width>l){var m=l-k.left-k.width-13;$(window).scrollLeft(-m)}f.$filterToggleLink.click()}a.stopPropagation()}),[g.find("span:nth-child(1)"),g.find("span:nth-child(2)")].forEach(function(b){a(b,f(b))}),j.addRunLinks(),j.$_inlineOK.click(r),j.$_inlineCancel.click(function(){h.click()})}}),__reportQBO.QueryBuilder&&$("th.sortable[data-resizable-column-id]:not(:has(span[data-column-id]))").each(function(){for(var b=$(this),c=b.data("resizable-column-id"),d=__reportQBO.QueryBuilder.resultColumns,f=0;f<d.length;f++){var g=d[f].resultColumn;if(g.variableName===c){var h=g.customLabel;break}}h&&e._filterCollection.each(function(c){c.columnId||c.title()===h&&a(b,function(){var a=c.getDisplayValues();return $.isArray(a)&&(a=a.join(", ")),a})})}),this.updateColumnStates()},p.prototype.removeFilter=function(a){delete this._reportParams[a],this._filterCollection.remove(a).destroy(),this.layout()},p.prototype.getFilter=function(a){return this._filterCollection.get(a)},p.prototype.runQueries=function(a,b,c){var d=[];this.each(function(c){c&&(c.runQuery?a?d.push(c):c.runQuery():c.loadFromOSValues(b))}),d.length>0?!function e(f){var g=d[f];$("#_paramsClearButton").addClass("disabled"),g.runQuery(function(){b&&g.loadFromOSValues(b),f++,f<d.length?e(f):($("#_paramsClearButton").removeClass("disabled"),n.addTooltipHelpParent("#_paramsClearButton","#_paramsClearButton_tooltip",j.defaultChoicesTooltipForRevert,{title:j.defaultChoicesTitle,html:!0}),a())},c)}(0):a&&a()},p.prototype.layout=function(){this.$container.children().detach();var a=this;this.each(function(b,c,d,e){b.columnId||b.widget().appendTo(a.$container)})},p.prototype.getReportParameters=function(){var a=[],b=this;return this._filterCollection.ids().forEach(function(c){var d=b._reportParams[c];delete d.parameterShortKind,a.push(d)}),a},p.prototype.removeAll=function(){var a=this,b=[];this.each(function(a,c,d){b.push(d)}),$.each(b,function(b,c){a.removeFilter(c)})},p.prototype.loadParameters=function(a){if(a){if(this.removeAll(),a=this.sortParameters(a),this.mergedColumns={},window.__reportQBO)try{for(var b="",c="",d=__reportQBO.QueryBuilder.resultColumns,e=0;e<d.length;e++){var f=d[e].resultColumn,g=f.customLabel,h=f.variableName;g!=b?(this.mergedColumns[h]="",c=h,b=g):this.mergedColumns[h]=c}}catch(i){}var j=this;a.forEach(function(a){var b=a["@id"];b&&-1!=b.indexOf("componentPicker")||j.createParam(a)}),w.forEach(function(a){j.__merge_filters(a.main,a.filter)}),this.layout()}},p.prototype.sortParameters=function(a){var b={item:function(a){return a?(a=a["@id"]||a,this[a]):null}};return a.forEach(function(a){b[a["@id"]]={id:a["@id"],children:[],parentId:a.dependsOnParameter,parent:function(){return this.parentId?b[this.parentId]:null},child:function(a){return b.item(this.children[a])},_priority:function(){if(this.priority)return this.priority;this.priority=this.parent()?1:0;for(var a=0;a<this.children.length;a++)this.priority+=this.child(a)._priority();return this.priority},_level:function(){if(this.level)return this.level;this.level=0;for(var a=this.parent();a;)this.level++,a=a.parent();return this.level}}}),a.forEach(function(a){var c=b.item(a),d=b.item(c.parentId);d&&d.children.push(c.id)}),a.sort(function(a,c){var d=b.item(a),e=b.item(c);if(a.reportQueryVariableKind===s.uConfigurationPickerKind){var f=d.parent(),g=f?f.parent():null;return f&&e.id===f.id||g&&e.id===g.id?1:-1}if(c.reportQueryVariableKind===s.uConfigurationPickerKind){var f=e.parent(),g=f?f.parent():null;return f&&d.id===f.id||g&&d.id===g.id?-1:1}var h=d._priority(),i=e._priority();if(i>h)return 1;if(h>i)return-1;var j=d._level(),k=e._level();if(k>j)return-1;if(j>k)return 1;var l=parseInt(d.id.split("#reportparameter-")[1]),m=parseInt(e.id.split("#reportparameter-")[1]);return m>l?-1:l>m?1:0}),a},p.prototype.showContent=function(){this.mark(!1)},p.prototype.each=function(a){var b=this;this._filterCollection.each(function(c,d,e){b._filters&&b._filters.length&&(c.conditionFilter=b._filters[0]),a(c,b._reportParams[d],d,e)})},p.prototype.hasAllRequiredValues=function(){return null!=this.getFilterString()},p.prototype.getFilterString=function(){var a=[],b=[],c=!0,d=this;if(this.each(function(e,f){e.setErrorState(!1);var g=e.getQueryVariableKind(),h=void 0,i=void 0;g===s.uStringTemplateKind?(h=e.getTemplateFilterString(),i=a):g===s.uConfigurationPickerKind?(h=e.getConfigurationFilterString(d.configurationContext),i=a):g===s.uReportableRestKind&&(h=e.getQueryFilterString(!0),i=b);var j=null!=h&&""!==h&&void 0!=h;j&&i.push(h),!e.columnId&&e.isInReportQuery()&&e.isRequired()&&!j&&(e.setErrorState(!0),c=!1)}),!c)return null;var e=[];return b.length>0&&e.push(p.buildFilterParam(b)),a.length>0&&e.push(a.join("&")),this._reconfigure&&e.push("reconfigure=true"),this._options&&this._options.gadget&&this._options.gadget._isDrillDown&&this._options.gadget._isDrillDown===!0&&e.push("dd=true"),0==e.length?"":e.join("&")},p.buildFilterParamFromValues=function(b,c){var d=[];for(var e in b){var f=a.buildQueryFilter(e,b[e],c?c[e]:{});f&&d.push(f)}return d.length>0?p.buildFilterParam(d):""},p.buildFilterParam=function(a){return"fields="+encodeURIComponent("results/result["+a.join(" and ")+"]")},p.prototype.findUnusedTemplateVariables=function(a){a||(a=[]);var b=a.slice(0);return this.each(function(a,c){var d=a.getQueryVariableKind();if(d===s.uStringTemplateKind){var e=a.getTemplateFilterString();if(null!=e){var f=a.getQueryVariable(),g=$.inArray(f,b);-1!==g&&b.splice(g)}}}),b},p.prototype.getDisplayValues=function(){var a=[],b={};return this.each(function(c,d){var e=c.title();a.push(e),b[e]=c.getDisplayValues()}),[a,b]},p.prototype.getSelectedValues=function(){var a={};return this.each(function(b,c){var d=b.getQueryVariable();if(d){var e=b.getValues();e&&e.length&&e.length>0&&(a[d]=e)}}),p.makeVersionedValueObject(a)},p.makeVersionedValueObject=function(a){return{version:"2.0",values:a}},p.prototype.loadValues=function(a){var b="1.0",c=a;a.version&&(b=a.version,c=a.values);var d=this._filters,e=this,f=[];if(d)for(var g=0;g<d.length;g++){var h=d[g];h.runtimeVar&&f.push(h.runtimeVar)}if(f.length>0){var i=f[0].indexOf("_");i>0&&(i++,f.sort(function(a,b){var c=parseInt(a.substring(i)),d=parseInt(b.substring(i));return c-d}))}var k=[],l={};if(d&&d.length>0){for(var m=[],g=0;g<d.length;g++){var h=d[g];h.runtimeVar&&h.id&&"exactdate"===h.relativeDateOp&&"after (including)"==h.operator&&(m[h.id]=h.runtimeVar)}for(var g=0;g<d.length;g++){var h=d[g];if(h.runtimeVar&&(l[h.runtimeVar]=!0),h.runtimeVar&&h.id&&"exactdate"===h.relativeDateOp&&"before (including)"==h.operator){var n=m[h.id];if(n&&h.value&&1===h.value.length){var o=h.value[0],p=f.indexOf(n),q=f.indexOf(h.runtimeVar);q-p===1&&"string"==typeof o&&3===o.split("-").length&&(k[n]=o)}}}}if(this.each(function(a,d){var f=a.getQueryVariable();if("1.0"===b&&(f+="Inputs"),"oslc_config.context"==f){var g="rb-config-picker",h=$.cookies.get(g);h&&e.setConfigContext(h)}l[f]=!0;var i=c[f];if(d.parameterKind&&s.uDateRangeKind===d.parameterKind&&e.isParamInCondition(f)){if(i&&1===i.length){var m=k[f];i[0]&&m&&i.push(m)}(!i||i&&$.isArray(i)&&i.length<2)&&(i=[],i.push(""),i.push(""),a.setDefaultDisplayValue&&a.setDefaultDisplayValue(j.usePresetDateCondition))}i=i?i:[],a.setSelectedValues(i)}),this._reconfigure=!1,c)for(var r in c)if(!l[r]){var t=r.split(".");if(!l[t[0]]){this._reconfigure=!0;break}}this.updateState()},p.prototype.getConfigParameter=function(){var a=null;return this.each(function(b){b.isConfigurationParameter()&&(a=b)}),a},p.prototype.setConfigContext=function(a){"unset"===a&&this.configurationContext&&this.configurationContext.length>0||(this.configurationContext=a)},p.prototype.isModified=function(){var a=this.getState();return a!==this.originalState},p.prototype.updateState=function(){this.originalState=this.getState()},p.prototype.getState=function(){return JSON.stringify(this.getSelectedValues())},p.prototype.collectFilters=function(a,b){if(a&&a.length)for(var c=0;c<a.length;c++){var d=a[c].filter;if(d)b.push(d);else if(a[c].group){var e=a[c].group.filtersAndGroups;this.collectFilters(e,b)}}},p.prototype.isParamInCondition=function(a){var b=!1;return a&&this._filters&&this._filters.length&&this._filters.length>0&&$.each(this._filters,function(c,d){return d.runtimeVar==a?(b=!0,!1):void 0}),b},p.prototype.updateColumnStates=function(){this._filterCollection.each(function(a){if(a.$hdrEdit){var b=a.getValues();b&&0!==b.length?a.$hdrEdit.addClass("dirty"):a.$hdrEdit.removeClass("dirty")}})},p.prototype.refreshFilters=function(a){if(this.columnId){var b=this.widget();b.find("a.jrs-param-selection-link[data-attachpt=_refreshButton]").click()}},p.FilterFactories=t,p.DefaultOptions=v,p.Events=l.CreateEventEnums("CreatingFilter","FilterCreated"),a.Events=p.Events,p});