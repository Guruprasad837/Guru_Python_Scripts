/*******************************************************************************
 * Licensed Materials - Property of IBM
 * Â© Copyright IBM Corporation 2013, 2023. All Rights Reserved.
 * 
 * Note to U.S. Government Users Restricted Rights:
 * Use, duplication or disclosure restricted by GSA ADP Schedule
 * Contract with IBM Corp.
 *******************************************************************************/
define(["chart/oneUIColours","common/htmlUtils","common/bidiUtils","i18n!nls/messages"],function(a,b,c,d){function e(a,b){var c,d,e=[],g="",h=a.split(" ");for(c=0;c<h.length;)d=f(g,h[c]),d.length>b?(0==g.length&&(g=d,c++),e.push(g),g=""):(g=d,c++);return g.length>0&&e.push(g),e}function f(a,b){return 0!=a.length&&(a+=" "),a+=b}var g=500,h=400,i=.9,j=function(b,d){this._owningElement=b,this.textDir=c.getPreferredBaseTextDir(),d.chartData.negativeValues=!1,d.supportsSeries||this.transformData(d);var e=this.getPalette(d),f=null;d.chartData.groupColor&&"piechart"!==d.type&&"barchart"!==d.type&&"linechart"!==d.type&&(f=d3.rgb(d.chartData.groupColor.toLowerCase()));var k=!1;if(d.calcs&&d.calcs.length>2){var l=d.calcs.split(",");l.length>0&&d.chartData.origSeries&&d.chartData.data.length===l.length&&d.chartData.origSeries.length===d.chartData.data.length&&(k=!0)}for(var m=0;m<d.chartData.data.length;m++){if(k&&"string"==typeof d.chartData.origSeries[m].color)d.chartData.data[m].colour=d3.rgb(d.chartData.origSeries[m].color);else{var n=d.chartData.data[m].colour;d.chartData.data[m].colour=f?f:n&&"null"!=n?void 0==n.r?d3.rgb(n.toLowerCase()):n:d.monoColour?d3.rgb(d.monoColour.r,d.monoColour.g,d.monoColour.b):e[m]?d3.rgb(e[m].r,e[m].g,e[m].b):OneUIColours.MONO_CHART_COLOR1}d.chartData.data[m].label=this._htmlDecode(d.chartData.data[m].label),d.chartData.data[m].label=c.enforceTextDirWithUcc(d.chartData.data[m].label,this.textDir);for(var o=0;o<d.chartData.data[m].value.length;o++)if(d.chartData.data[m].value[o]<0){d.chartData.negativeValues=!0;break}}if(d.supportsSeries){d.seriesLabel=[];var p=[];d.calcs&&("["==d.calcs[0]?(p=d.calcs.substring(1,d.calcs.length-1),p=p.split(",")):p.push(d.calcs));var q=[];d.seriesTypes&&("["==d.seriesTypes[0]?(q=d.seriesTypes.substring(1,d.seriesTypes.length-1),q=q.split(",")):q.push(d.seriesTypes));var r=[];if(d.seriesYAxes)"["==d.seriesYAxes[0]?(r=d.seriesYAxes.substring(1,d.seriesYAxes.length-1),r=r.split(",")):r.push(d.seriesYAxes);else if(d.chartData.series&&d.chartData.series.length>0)for(var m=0;m<d.chartData.series.length;m++){var s=d.chartData.series[m].graphYAxis;s&&s.length>0&&r.push(s)}for(var t=d3.scale.ordinal().range(e),m=0,u=d.chartData.series.length;u>m;m++){var v=d.chartData.series[m],w=t(m);if(v.color&&""!=v.color)w=void 0===v.color.r?d3.rgb(v.color.toLowerCase()):v.color;else{if(String.prototype.trim||!function(){var a=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;String.prototype.trim=function(){return this.replace(a,"")}}(),d.chartData.groupColor&&1===d.chartData.series.length&&""===d.chartData.series[0].varName)w=d3.rgb(d.chartData.groupColor);else if("linechart"===d.type&&1===d.chartData.series.length&&""===d.chartData.series[0].varName&&d.chartData.data.length>0){for(var x,y,z,A,B,o=0;o<d.chartData.data.length;o++){var C=d.chartData.data[o];if(C.colour&&(x||(x=C.colour),C.value&&1===C.value.length)){var D=C.value[0];void 0===A?(A=B=D,z=y=C.colour):(D>A&&(A=D,z=C.colour),B>D&&(B=D,y=C.colour))}}w="top"===d.sort?z:"bottom"===d.sort?y:x,w||(w=a.MONO_CHART_COLOR1)}else w=d3.rgb(w.r,w.g,w.b);v.color=w}!d.isTimeSeries||"__auto__"!=d.count||d.series&&d.series!=d.group||(v.label=d.countTitle),v.label=this._htmlDecode(v.label),d.seriesLabel[m]={label:v.label,colour:w,type:q.length>m?q[m]:"default",calc:p.length>m?p[m]:"sum"},m<r.length&&(d.seriesLabel[m].graphYAxis=r[m])}}d.fullPreview=this._owningElement.classList&&this._owningElement.classList.contains("chart-preview-site");try{d.chartData.queryLimitTooltip&&!d.fullPreview&&($(".limitTooltip>img").attr("style",""),$(".limitTooltip .limitTooltipTitle")[0].innerHTML="",$(".limitTooltip .limitTooltipTitle").append(d.chartData.queryLimitTooltip))}catch(E){console.error(E)}d.supportsSeries&&this.transformData(d);var F=d3.select(this._owningElement);this.svgContainer=F.append("svg").attr("preserveAspectRatio","xMidYMid meet"),this.margin=this.getMargin(d),this.adjustSize(d),this.fontSize=10,(d.height>=600||d.width>=600)&&(this.fontSize=12),this.bottomChart=this.margin.bottom,this.sideChart=this.margin.left;var G=this.doCreateLegend(d),H=this.doCreateTotals(d),I=0;this.width=d.width-this.margin.left-this.margin.right;var J,K,L=G?G[0][0].getBoundingClientRect():{width:0,height:0},M=20;if(G||H){var N=H?H[0][0].getBoundingClientRect():{width:0,height:0},O=Math.max(L.height,N.height),P=L.width+N.width+M;if(d.seriesLabel&&d.seriesLabel.length>0&&!H){for(var m=0;m<d.seriesLabel.length;m++){var Q=d.seriesLabel[m];if(Q.label&&Q.label.length>81){P=L.width+200;break}}P>g&&(d.width=L.width>d.width?L.width:d.width)}P>g&&N.height>0&&(I=!0,d.width=L.width>d.width?L.width:N.width>d.width?N.width:d.width,O=L.height+N.height+M+20),H&&d.side===!0&&d.height>3*d.width&&(J=N.width,O-=N.height),this.margin.bottom+=O,d.height+=O}if(d.preview&&(F.attr("style",""),this.svgContainer.attr("viewBox","0 0 "+d.width+" "+d.height)),d.chartTitle){this.margin.top+=20;var R=this._htmlDecode(d.chartTitle),S=R;S.length>80&&(S=S.substring(0,77)+"...");var T=this.svgContainer.append("text");T.attr("transform","translate("+this.sideChart+" ,15)").style("text-anchor","start").style("font-size",this.fontSize+"px").attr("class","chart-text-title").text(S),!d.fullPreview&&R.length>S.length&&T.on("mouseover",PROXY(function(a){this._showTooltip({label:R},d3.event)},this)).on("mousemove",PROXY(function(a){this._showTooltip({label:R},d3.event)},this)).on("mouseout",PROXY(function(a){this._hideTooltip()},this))}this.height=d.height-this.margin.top-this.margin.bottom;var U=this.getChartGroup();if(d.preview&&U.attr("class","preview"),this.extraHeight=5,this.extraWidth=50,this.doChart(U,d),!d.preview){var V=d.width+this.extraWidth+20,W=d.height+this.extraHeight+20;if(J>0&&(K=d.width+70,V+=J+20,W=d.height),!this._owningElement.classList||this._owningElement.classList.contains("chart-site-print"))F.attr("width",V+100).attr("height",W+100),F.attr("style",""),this.svgContainer.attr("width",V).attr("height",W),this.svgContainer.attr("style","overflow: visible");else{var X=this._owningElement.offsetWidth,Y=this._owningElement.offsetHeight;X&&Y&&X>V&&Y>W?F.attr("style",""):F.attr("style","overflow: scroll"),this.svgContainer.attr("width",V).attr("height",W)}if(d.fullPreview){var Z=V+this.margin.left,_=W+this.margin.top+20;this.svgContainer.attr("width","100%").attr("height","100%"),this.svgContainer.attr("viewBox","0 0 "+Z+" "+_);var aa=Z,ba=_,ca=aa/ba;d.side?ba>h&&(ba=h,aa=ba*ca):aa>g&&(aa=g,ba=aa/ca),aa*=i,ba*=i,F.attr("style","width:"+aa+"px; height: "+ba+"px")}}var da=d.chartData.reportTitle;da&&(F.attr("alt",da),this.svgContainer.attr("alt",da));var ea=this.height+this.bottomChart+this.extraHeight+this.margin.top+20,fa=L.width+20+this.sideChart;if(G&&(ea=-1===G.attr("class").indexOf("moreColorMsg")?ea:ea+10,G.attr("transform","translate("+this.sideChart+","+ea+")"),I&&(ea+=L.height+M,fa=this.sideChart)),H&&(K>0&&(fa=K,ea=20),H.attr("transform","translate("+fa+","+ea+")")),d.noDataMessage){var ga=this.getContainerForNoDataMessage(d).append("text").attr("class",d.previewLink?"chart-nodata-link":"chart-nodata").style("font-size","16px").text(d.noDataMessage),ha=(this.width-(ga.node()?ga.node().getComputedTextLength():0))/2,ia=this.height/2;if(0>ha){ha=20;var ja=ga.node().clientHeight+5;20>ja&&(ja=20);var ka=d.noDataMessage,la=0;ka.length>0&&ga.node().getComputedTextLength()>0&&(la=ga.node().getComputedTextLength()/ka.length),5>la&&(la=5);for(var ma=Math.floor(this.width/la)-1,na=new Array;ka.length>ma;){var m=ka.lastIndexOf(" ",ma);-1==m&&(m=ma);var oa=ka.substring(0,m);if(na.push(oa),ka=j.trimString(ka.substring(m)),ka.length<=ma){na.push(ka);break}}ia=(this.height-na.length*ja)/2;for(var pa=this.getContainerForNoDataMessage(d),m=0;m<na.length;m++){var oa=na[m];0==m?ga.style("font-size","15px").text(oa):ga=pa.append("text").attr("class",d.previewLink?"chart-nodata-link":"chart-nodata").style("font-size","15px").text(oa),ga.attr("x",ha).attr("y",ia),ia+=ja}}else ga.attr("x",ha).attr("y",ia)}U.selectAll(".path").sort(function(a,b){return void 0==a&&void 0==b||void 0!=a&&void 0!=b?0:void 0!=a?-1:1})};return j.prototype.hasDrillDown=function(a){if(a&&a.series)for(var b in a.series){var c=a.series[b],d=c.subreport;return d?!0:!1}return!1},j.prototype.getContainerForNoDataMessage=function(){return this.svgContainer.select(".message")},j.prototype.doCreateLegend=function(a){if(a.noDataMessage)return null;if(!a.preview&&a.supportsSeries&&a.seriesLabel.length>0){if(a.seriesLabel.length<=OneUIColours.COLOUR_PALETTE_DESIGNCORE.length){var b=a.seriesLabel;if(a.seriesLabel&&a.seriesLabel.length>0)for(var c=0;c<a.seriesLabel.length;c++){var e=a.seriesLabel[c];if((!e.label||""==e.label||" "==e.label)&&a.unassignedMsg){b=j.cloneObject(a.seriesLabel),b[c].label=a.unassignedMsg;break}}return this._createLegend(this.svgContainer,b,a.legendOrientation,a)}}else if(a.chartData.data.length>0&&a.chartData.data.length<=OneUIColours.COLOUR_PALETTE_DESIGNCORE.length){for(var b=[],c=0;c<a.chartData.data.length;c++){var e=a.chartData.data[c];if(e.colour&&e.drilldown){var f=e;""===f.label&&a.unassignedMsg&&(f=j.cloneObject(e),f.label=a.unassignedMsg),b.push(f)}}if(b.length>0)return this._createLegend(this.svgContainer,b,a.legendOrientation,a)}if(a.chartData.data.length>0&&a.chartData.data.length>OneUIColours.COLOUR_PALETTE_DESIGNCORE.length||a.supportsSeries&&a.seriesLabel.length>0&&a.seriesLabel.length>OneUIColours.COLOUR_PALETTE_DESIGNCORE.length){var g=this.svgContainer.append("g").attr("class","legend moreColorMsg"),h=g.append("rect").attr("class",function(){return"hide"}).attr("height",function(){return 10}).attr("width",function(){return 10});g.append("g").attr("class","legend-entry").append("text").text(d.noLegendMsg);var i=g[0][0].getBoundingClientRect();return h.attr("height",function(){return i.height}).attr("width",function(){return i.width+2}),g}},j.prototype.doCreateTotals=function(a){var b=!a.noDataMessage&&!a.preview&&a.showTotals;return b?this._createTotals(a,this.svgContainer,a.chartData.data):null},j.prototype.transformData=function(a){if(!a.supportsSeries&&a.chartData.data.length>0&&(a.chartData.series.length>1||a.chartData.series[0].label&&""!=a.chartData.series[0].label)){newData=[];for(var b=0,c=a.chartData.data.length;c>b;b++)for(var d=0,e=a.chartData.series.length;e>d;d++){var f=a.chartData.series[d].label,g=a.chartData.data[b].label;""===f&&a.unassignedMsg&&(f=a.unassignedMsg),""!=f&&(g+=" "+f);var h="",i="";h=a.group&&a.chartData.data[b].colour?a.chartData.data[b].colour:a.chartData.series[d]?a.chartData.series[d].color:null,a.chartData.group||1!==a.chartData.data.length||(i=a.chartData.data[0].drilldown[""][a.chartData.series[d].varName]),newData.push({label:this._htmlDecode(j.trimString(g)),varName:a.chartData.series[d].varName,href:a.chartData.data[b].href,colour:h,seriesIdx:d,categoryIdx:b,value:[a.chartData.data[b].value[d]],drilldown:i})}a.chartData={series:[""],data:newData,origSeries:a.chartData.series}}a.sort&&""!=a.sort&&(a.chartData.data=a.chartData.data.slice(),a.chartData.data.sort(function(b,c){for(var d=0,e=0;e<b.value.length;e++)d+=b.value[e]?b.value[e]:0;for(var f=0,e=0;e<c.value.length;e++)f+=c.value[e]?c.value[e]:0;return"top"==a.sort?f-d:d-f}))},j.prototype.getChartGroup=function(){return this.svgContainer.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")")},j.prototype.getMargin=function(a){return{left:25,top:15.5,right:0,bottom:20}},j.prototype.getPalette=function(b){return a.getRandomColoursArray(b.chartData.data.length)},j.prototype.adjustSize=function(a){a.side?a.height=Math.max(a.height,20*a.chartData.data.length)+20:a.width=Math.max(a.width,20*a.chartData.data.length)},j.prototype.doChart=function(a){},j.prototype._getTextMetrics=function(a,b){var c=0;try{c=a.getComputedTextLength()}catch(d){return}var e=a.getNumberOfChars(),f=c/e;return{fittedCharLength:Math.min(e-1,b/f+1),textLength:c}},j.prototype.shouldTrimTextToContainer=function(a,b){var c=this._getTextMetrics(a,b);return c&&c.textLength>b&&c.textLength>=0?!0:!1},j.prototype.trimTextToContainer=function(a,b){var c=a.textContent,d=this._getTextMetrics(a,b);if(!d)return b;for(var e=d.textLength,f=Math.max(0,d.fittedCharLength-3);e>b&&f>=0;)a.textContent=c.substring(0,f--)+"...",e=a.getComputedTextLength();return e>b&&(a.textContent=""),e},j.prototype.tooltipDiv=null,j.prototype.isToolTipShowing=!1,j.prototype.getTooltipLabel=function(a,b){if(""===a.label&&b.unassignedMsg)return b.unassignedMsg;if(a.label){if(-1!=a.label.indexOf("%2c")){var c=new RegExp("%2c","g");a.label=a.label.replace(c,",")}return a.label}return a},j.prototype.getTooltipValue=function(a,b){return a instanceof Object&&a.value?a.value:""},j.prototype._createToolTip=function(){this.tooltipDiv=d3.select("body").append("div").attr("class","query-tooltip")},j.prototype._showTooltip=function(a,c,d){if(this.tooltipDiv||this._createToolTip(),null!=c){var e=c.pageY,f=c.pageX+20,g=b.encodeHtml(this.getTooltipLabel(a,d));if(!g)return;var h="value",i=this.getTooltipValue(a);j._isSecondYAxis(a.graphYAxis)&&d&&d.type&&("barchart"===d.type||"groupedbarchart"===d.type)&&(h="y2AxisTooltipText");var k='<div><span class="name">'+g+"</span>"+(a instanceof Object&&a.value?': <span class="'+h+'">'+i+"</span>":"")+"</div>";if(this.tooltipDiv.html(k).style("top",e+"px").style("left",f+"px"),this.isToolTipShowing)return;this.isToolTipShowing=!0,this.tooltipDiv.style("display","block").transition().duration(600).style("opacity",1)}},j.prototype._hideTooltip=function(){this.isToolTipShowing&&(this.tooltipDiv&&this.tooltipDiv.style("display","none").style("opacity",0),this.isToolTipShowing=!1)},j.prototype._htmlDecode=function(a){return b.decodeHtml(a)},j.prototype._createTotals=function(a,b,c){var d=16,e=10,f=3,g=e,h=b.append("g").attr("class","legend"),i=h.append("rect").attr("class","legend-background"),j=h.selectAll(".legend-entry").data(c).enter().append("g").attr("class","legend-entry"),k=h.append("g").attr("class","legend-entry");k.append("text").attr("class","legend-text-title").attr("x",function(a){return e}).attr("y",function(a){return g}).attr("dy",".85em").style("font-size",this.fontSize+"px").text(function(){return a.totalsMsg});var l=k.append("line").attr("class","legend-separator");l.attr("x1",function(a){return 0}).attr("y1",function(a){return g+d-f}).attr("y2",function(a){return g+d-f}),g+=d;var m=g,n=this;j.each(function(b,c){var f=d3.select(this);f.append("text").attr("class","legend-text").attr("x",function(a){return e}).attr("y",function(a){return g}).attr("dy",".85em").style("font-size",n.fontSize+"px").text(PROXY(function(b){return this._htmlDecode(this.getTooltipLabel(b,a))},n)),g+=d});var k=h.append("g").attr("class","legend-entry");k.append("text").attr("class","legend-text-title").attr("x",function(a){return e}).attr("y",function(a){return g}).attr("dy",".85em").style("font-size",this.fontSize+"px").text(function(){return a.totalMsg});var o=k.append("line").attr("class","legend-separator");o.attr("x1",function(a){return 0}).attr("y1",function(a){return g-f}).attr("y2",function(a){return g-f}),g=m;var p=h[0][0].getBoundingClientRect(),q=e+p.width+e,r=0;return j.each(function(b,c){var e=d3.select(this);e.append("text").attr("class","legend-text").attr("x",function(a){return q}).attr("y",function(a){return g}).attr("dy",".85em").style("font-size",n.fontSize+"px").text(PROXY(function(b){var c=0,d=0;a.chartData&&a.chartData.series&&a.chartData.series.length>0&&(d=a.chartData.series.length);for(var e=0;e<b.value.length;e++){if(d>e&&a.chartData.series[e]){var f=a.chartData.series[e].varName;if(f&&(0===f.indexOf("__GL__")||0===f.indexOf("__DL__")))continue}c+=b.value[e]}return r+=c,1==b.value.length?this.getTooltipValue(b,a):c%1!==0?parseFloat(c.toFixed(5)):c},n)),g+=d}),k.append("text").attr("class","legend-text").attr("x",function(a){return q}).attr("y",function(a){return g}).attr("dy",".85em").style("font-size",this.fontSize+"px").text(function(){return r%1!==0?parseFloat(r.toFixed(5)):r}),p=h[0][0].getBoundingClientRect(),i.attr("height",function(a){return p.height+e}).attr("width",function(a){return p.width+e}),o.attr("x2",function(a){return p.width+e}),l.attr("x2",function(a){return p.width+e}),h},j.prototype._createLegend=function(a,b,c,f){var g;if(b&&b.length>OneUIColours.COLOUR_PALETTE_DESIGNCORE.length){g=a.append("g").attr("class","legend moreColorMsg");var h=g.append("rect").attr("class",function(){return"hide"}).attr("height",function(){return 10}).attr("width",function(){return 10});g.append("g").attr("class","legend-entry").append("text").text(d.noLegendMsg);var i=g[0][0].getBoundingClientRect();h.attr("height",function(){return i.height}).attr("width",function(){return i.width+2})}else{var k=10,l=6,m=10,n=m;g=a.append("g").attr("class","legend");var h=g.append("rect").attr("class","legend-background"),o=g.selectAll(".legend-entry").data(b).enter().append("g").attr("class","legend-entry"),p=this;o.each(function(a,b){var c=d3.select(this);c.append("rect").attr("class","legend-swatch").attr("x",function(a){return m}).attr("y",function(a){return n}).attr("height",function(a){return k}).attr("width",function(a){return k}).style("fill",function(a){var b=a.colour;return d3.rgb(b.r,b.g,b.b)}).style("stroke",function(a){var b=a.colour;return d3.rgb(b.r,b.g,b.b).darker()}).style("stroke-width",1);var g=a.label,h=!1;j._isSecondYAxis(a.graphYAxis)&&f&&(h=!0,"stackedbarchart"!==f.type||"bar"!==a.type&&"default"!==a.type?"linechart"===f.type&&("bar"===a.type?h=!1:f.chartData.series&&f.chartData.series.length>0&&""===f.chartData.series[0].varName&&(h=!1)):h=!1,h&&(g=f.side?d.legendForTopY2Axis.replace("{0}",g):d.legendForRightY2Axis.replace("{0}",g))),c.append("text").attr("class",h?"legend-text2":"legend-text").attr("x",function(a){return m+k+l}).attr("y",function(a){return n}).attr("dy",".85em").style("font-size",p.fontSize+"px").text(PROXY(function(a){if(this._htmlDecode(g)&&-1!=this._htmlDecode(g).indexOf("%2c")){var b=new RegExp("%2c","g");g=g.replace(b,",")}if(!(this._htmlDecode(g).length>110))return this._htmlDecode(g);g=e(g,110);for(var d=0;d<g.length;d++)d>0&&(n=n+k+l),c.append("text").attr("x",function(a){return m+k+l}).attr("y",function(a){return n}).attr("dy",".85em").style("font-size",p.fontSize+"px").text(PROXY(function(a){return this._htmlDecode(g[d])},p))},p)),n=n+k+l,b===o[0].length-1&&c.append("text").attr("class",h?"legend-text2":"legend-text").attr("x",function(a){return-10}).attr("y",function(a){return n}).style("fill",function(a){return d3.rgb("#ffffff")}).text(PROXY(function(a){return"."},p))});var i=g[0][0].getBoundingClientRect();h.attr("height",function(a){return i.height+m}).attr("width",function(a){return i.width+2*m})}return g},j._isSecondYAxis=function(a){return"Y2"===a?!0:!1},j.trimString=function(a){return"string"==typeof a?a.replace(/^\s+|\s+$/gm,""):a},j.cloneObject=function(a){if(null==a||"object"!=typeof a)return a;if("function"==typeof a.clone)return a.clone(!0);if(a instanceof Date)return new Date(a.getTime());if(a instanceof RegExp)return new RegExp(a);if(a.nodeType&&"function"==typeof a.cloneNode)return a.cloneNode(!0);if(a instanceof Array){for(var b=[],c=0,d=a.length;d>c;c++)b[c]=j.cloneObject(a[c]);return b}if(a instanceof Object){var b={};for(var e in a)a.hasOwnProperty(e)&&(b[e]=j.cloneObject(a[e]));return b}return a},j});