/*******************************************************************************
 * Licensed Materials - Property of IBM
 * Â© Copyright IBM Corporation 2013, 2022. All Rights Reserved.
 * 
 * Note to U.S. Government Users Restricted Rights:
 * Use, duplication or disclosure restricted by GSA ADP Schedule
 * Contract with IBM Corp.
 *******************************************************************************/
define(["chart/2d/barchartbase","chart/oneUIColours","common/filter-date-utils"],function(a,b,c){var d=function(b,c){c.supportsSeries=!0,a.apply(this,arguments)};return SUBCLASS_FROM(d,a),d.prototype.transformData=function(b){if(a.prototype.transformData.call(this,b),0!=b.chartData.data.length&&!this.isLine(b)){for(var c=[],d=0,e=b.chartData.data.length;e>d;d++){c[d]=[b.chartData.data[d].label],c[d].push(b.chartData.data[d].href),c[d].push(b.chartData.data[d].labelAsDate);for(var f=0,g=b.chartData.series.length;g>f;f++){var h=f;if(b.grouped||(h=b.chartData.series.length-1-f),!this.isLine(b,h)){var i=b.chartData.data[d].value[h];c[d].push(i?i:0)}}}if(b.sort&&""!=b.sort){var j=function(a){for(var b=0,c=1,d=a.length;d>c;c++){var e=parseInt(a[c]);isNaN(e)||(b+=e)}return b};c.sort(function(a,c){var d=j(a),e=j(c);return"top"==b.sort?e-d:d-e})}var k=this,l=[];b.numLines=0;for(var d=0;d<b.chartData.series.length;d++){var h=b.grouped?d:b.chartData.series.length-1-d;if(this.isLine(b,h)){if(b.numLines++,!b.noValZero)for(var m=0,n=b.chartData.data,f=n.length-1;f>=0;f--){var o=n[f].value[h];o&&(m=o),null===o&&m&&(n[f].value[h]=m)}}else l.push(b.seriesLabel[h])}if(b.chartData.negativeValues){if(b.numLines<b.chartData.series.length){var p=l.map(function(a,d){return c.map(function(a,c){var e={colour:l[d].colour,calc:l[d].calc,href:l[d].href,group:b.chartData.group,sectionLabel:k._htmlDecode(l[d].label),label:k._htmlDecode(a[0]),href:a[1],labelAsDate:a[2],y:parseFloat(a[d+3]),value:a[d+3]};return l[d].graphYAxis&&(e.graphYAxis=l[d].graphYAxis),e})});if(p.length>0&&p[0].constructor===Array){var q=[],r=[];for(var d in p){var s=p[d].map(function(a){return a.value<0?a:{value:0,y:0,label:"dummy"}}),t=p[d].map(function(a){return a.value>=0?a:{value:0,y:0,label:"dummy"}});q.push(t),r.push(s)}if(b.stackedDataNeg=d3.layout.stack()(r),b.stackedDataNeg=b.stackedDataNeg.map(function(a){var b=a.filter(function(a){return"dummy"!=a.label});return b}),b.stackedDataPos=d3.layout.stack()(q),b.stackedDataPos=b.stackedDataPos.map(function(a){var b=a.filter(function(a){return"dummy"!=a.label});return b}),void 0!=b.stackedDataPos&&void 0!=b.stackedDataNeg){var u=b.stackedDataPos.length,v=b.stackedDataNeg.length,w=u-v>=0?u:v,x=[];if(b.sort&&""!=b.sort&&"bottom"==b.sort)for(var y=0;w>y;y++)v>u?u>y?x[y]=b.stackedDataNeg[y].concat(b.stackedDataPos[y]):x[y]=b.stackedDataNeg[y]:v>y?x[y]=b.stackedDataNeg[y].concat(b.stackedDataPos[y]):x[y]=b.stackedDataPos[y];else for(var y=0;w>y;y++)v>u?u>y?x[y]=b.stackedDataPos[y].concat(b.stackedDataNeg[y]):x[y]=b.stackedDataNeg[y]:v>y?x[y]=b.stackedDataPos[y].concat(b.stackedDataNeg[y]):x[y]=b.stackedDataPos[y];b.stackedData=x}else void 0!=b.stackedDataPos?b.stackedData=b.stackedDataPos:b.stackedData=b.stackedDataNeg}}}else if(b.numLines<b.chartData.series.length){var p=l.map(function(a,d){return c.map(function(a,c){var e={colour:l[d].colour,calc:l[d].calc,href:l[d].href,group:b.chartData.group,sectionLabel:k._htmlDecode(l[d].label),label:k._htmlDecode(a[0]),href:a[1],labelAsDate:a[2],y:parseFloat(a[d+3]),value:a[d+3]};return l[d].graphYAxis&&(e.graphYAxis=l[d].graphYAxis),e})});b.stackedData=d3.layout.stack()(p)}}},d.prototype.adjustSize=function(b){return b.isTimeSeries&&this.isLine(b)?void(b.detail?b.width=Math.max(b.width,260):b.width=Math.max(b.width,100)):void a.prototype.adjustSize(b)},d.prototype.doGroupScale=function(b,c,d,e,f,g,h){if(!d.isTimeSeries||!this.isLine(d))return a.prototype.doGroupScale.call(this,b,c,d,e,f,g,h);var i=c[0].labelAsDate,j=c[c.length-1].labelAsDate,k=d3.time.scale().rangeRound([0,e]);k.domain([i,j]);var l=d3.svg.axis().scale(k).orient("bottom"),m=[];if(d.detail)if("Months"==d.dateScale)for(var n=0;n<c.length;n++)m.push(c[n].labelAsDate);else{var o=10,p=(j-i)/o,q=864e5,r=!1,s=!1,t=!1,u=!1,v=!1,w=!1;"Months"==d.dateScale?(t=!0,q*=30):"Weeks"==d.dateScale?(s=!0,q*=7):"Years"==d.dateScale?(u=!0,q*=365):r=!0,tickDiff=Math.max(1,p/q),o=Math.round((j-i)*q/p);var n=0,x=i,y=i;do y=x,n++,o>=n&&(r?x=d3.time.day.offset(x,tickDiff):s?x=d3.time.week.offset(x,tickDiff):t?x=d3.time.month.offset(x,tickDiff):u?x=d3.time.year.offset(x,tickDiff):v?x=d3.time.hour.offset(x,tickDiff):w?x=d3.time.minute.offset(x,tickDiff):n=o+6),j>y&&m.push(y);while(o>=n&&j>x);var z=j-y;z>=p&&m.push(j)}else m.push(i),m.push(j);var A=this;l.tickValues(m).tickFormat(function(a){return A.formatForDateScale(d,a).label}),d.preview&&l.tickSize(0);var B=b.append("g");B.attr("class","x axis").attr("transform","translate(0,"+this.height+")").call(l);var C=!1,D=B.selectAll("text"),E=D[0].length,F=D[0][0].getComputedTextLength(),G=F/2-this.margin.left/2;if(E>1)for(var H,n=0;E-1>n&&!C;n++){H=D[0][n+1].getComputedTextLength();var I;I=0===n?E>2?F-this.margin.left+H/2:F-this.margin.left+H:n===E-2?F/2+H:F/2+H/2,C=I>k(m[n+1])-k(m[n])-4,F=H}maxWidth=0;var A=this;return D.call(function(){if(this.length>0)for(var b=0,c=this[0].length;c>b;b++){var d=A.trimTextToContainer(this[0][b],a.MAX_TEXT_WIDTH);d>maxWidth&&(maxWidth=d)}}),C?(this.extraHeight=maxWidth/Math.sqrt(2),this.extraWidth=this.extraHeight,D.style("text-anchor","start").attr("dx","1.0em").attr("dy","0.5em").attr("transform",function(a){return"rotate(45)"})):(G>0&&d3.select(D[0][0]).attr("transform","translate("+G+", 0)"),E>0&&d3.select(D[0][E-1]).style("text-anchor","end")),d.groupTitle&&b.append("text").attr("transform","translate("+this.width/2+" ,"+(this.height+this.bottomChart-5+this.extraHeight)+")").style("text-anchor","middle").style("font-size",(this.fontSize>12?this.fontSize:12)+"px").text(this._htmlDecode(d.groupTitle)),k},d.prototype.doDrillDown=function(a,b,c,d){for(var e,f={},g=0,h=0,i=0;i<a.chartData.series.length;i++)this.isLine(a,i)||(b.sectionLabel&&b.sectionLabel===a.chartData.series[i].label&&(e=i,h++),f[g]=i,g++);if(window.___onDrilldown){var j=!1;a.isTimeSeries&&a.dateScale&&(j=!0,("first"===b.calc||"last"===b.calc||"sum"===b.calc)&&(j=!1)),1!==h&&(e=a.grouped?f[d]:a.chartData.series.length-1-f[d]),window.___onDrilldown(a,a.chartData,b,c,e,j,a.dateScale)}},d.prototype.getPalette=function(a){var c=a.chartData.series.length;return c<a.chartData.data.length&&(c=a.chartData.data.length),b.getRandomColoursArray(c,!a.grouped)},d.prototype.getTooltipLabel=function(b,c){var d=a.prototype.getTooltipLabel.call(this,b,c);return""===b.sectionLabel&&c.unassignedMsg?c.unassignedMsg:b.sectionLabel?b.sectionLabel:d},d.prototype.isGoalLine=function(a,b){var c=a.chartData.series[b].varName;return c&&0==c.indexOf("__GL__")?!0:!1},d.prototype.isDateLine=function(a,b){var c=a.chartData.series[b].varName;return c&&0==c.indexOf("__DL__")?!0:!1},d.prototype.isLine=function(a,b){if(void 0===b){if("linechart"==a.type){if(a.seriesLabel)for(var c=0;c<a.chartData.series.length;c++)if("bar"==a.seriesLabel[c].type)return!1;return!0}for(var c=0;c<a.chartData.series.length;c++)if(0!=a.seriesLabel[c].type.indexOf("line"))return"default"==a.seriesLabel[c].type&&(this.isDateLine(a,c)||this.isGoalLine(a,c))?!0:!1;return!0}return"linechart"==a.type&&"default"==a.seriesLabel[b].type||0==a.seriesLabel[b].type.indexOf("line")?!0:this.isDateLine(a,b)||"default"==a.seriesLabel[b].type&&this.isGoalLine(a,b)?!0:!1},d.prototype.isDashedLine=function(a,b){return"lineDash"==a.seriesLabel[b].type?!0:"default"==a.seriesLabel[b].type&&this.isGoalLine(a,b)?!0:!1},d.prototype.doChart=function(b,c){if(c.noDataMessage)return void a.prototype.doChart.call(this,b,c);var d,e,f=[],g=null,h=null,i=0,j="stackedbarchart"===c.type||"linechart"===c.type;if(j||"barchart"===c.type||"groupedbarchart"===c.type){for(var k=0,l=0,m=0;m<c.chartData.data.length;m++)if("[object Array]"===Object.prototype.toString.call(c.chartData.data[m].value)&&c.chartData.series.length===c.chartData.data[m].value.length)for(var n=c.chartData.data[m].value,o=0;o<n.length;o++){var p=null;a._isSecondYAxis(c.chartData.series[o].graphYAxis)&&(j?this.isLine(c,o)&&(p=n[o]):p=n[o]),null!=p?p>l&&(l=p):n[o]>k?k=n[o]:n[o]<i&&(i=n[o])}l>0&&k>0&&(d=k,e=l,e=Math.ceil(1.2*e))}if(this.isLine(c)){var q=this.doGroupScale(b,c.chartData.data,c,this.width,1,!1,this),r=this.doValueScale(b,c,this.height,!1,void 0,void 0,f,i);return f.length>0&&(h=f[0]),c.detail&&c.showGrids&&this.doGrid(b,r,"left",-this.width),this.putMessagePlaceHolder(b),void this.drawLineChart(c,b,q,r,!1,f)}if(c.stackedData){var s,t;c.chartData.negativeValues?(s=c.stackedDataPos?d3.max(c.stackedDataPos,function(a){return d3.max(a,function(a){return void 0==a.y0&&(a.y0=0),a.y0+a.y})}):0,t=void 0!=c.stackedDataNeg?d3.min(c.stackedDataNeg,function(a){return d3.min(a,function(a){return void 0==a.y0&&(a.y0=0),a.y0+a.y})}):0):s=d3.max(c.stackedData,function(a){return d3.max(a,function(a){return a.y0+a.y})});for(var u=c.chartData.data,m=0;m<c.chartData.series.length;m++)if(this.isLine(c,m)&&!a._isSecondYAxis(c.chartData.series[m].graphYAxis))for(var o=0;o<u.length;o++){var v=u[o].value[m];null!=v&&(s=Math.max(v,s),d=Math.max(v,d))}for(var m=0;m<c.chartData.series.length;m++)if(this.isLine(c,m)&&!a._isSecondYAxis(c.chartData.series[m].graphYAxis))for(var o=0;o<u.length;o++){var v=u[o].value[m];null!=v&&(t=Math.min(v,t))}var w=c.grouped?d:s,x=c.grouped?i:t,q=c.side?this.doValueScale(b,c,this.width,!0,w,e,f,x?x:i):this.doGroupScale(b,c.chartData.negativeValues?c.chartData.data:c.stackedData[0],c,this.width,.5,!1,this),r=c.side?this.doGroupScale(b,c.chartData.negativeValues?c.chartData.data:c.stackedData[0],c,this.height,.5,!0,this):this.doValueScale(b,c,this.height,!1,w,e,f,x?x:i);f.length>0&&(c.side?g=f[0]:h=f[0]),c.showGrids&&(c.side?this.doGrid(b,q,"bottom",this.height):this.doGrid(b,r,"left",-this.width)),this.putMessagePlaceHolder(b);var y=b.selectAll("g.valgroup").data(c.stackedData).enter().append("svg:g").attr("class","valgroup"),z=function(a){return""==a.label?c.unassignedMsg:a.label};if(c.grouped){var A=c.seriesLabel.length-c.numLines;this.doBars(y,c,function(a){return a},function(b){var d=q;return a._isSecondYAxis(b.graphYAxis)&&g&&(d=g),c.chartData.negativeValues?(void 0==b.y0&&(b.y0=0),c.side?Math.abs(d(0)-d(b.y)):d.rangeBand()/A):c.side?d(b.y):d.rangeBand()/A},function(b){var d=r;return a._isSecondYAxis(b.graphYAxis)&&h&&(d=h),c.side?d.rangeBand()/A:c.chartData.negativeValues?Math.abs(d(0)-d(Math.abs(b.y))):this.height-d(b.y)},function(a,b,d){return c.chartData.negativeValues?(a.y0=0,c.side?a.y<=0?q(0)-Math.abs(q(0)-q(a.y)):q(0):q(z(a))+q.rangeBand()/A*d):c.side?0:q(z(a))+q.rangeBand()/A*d},function(b,d,e){var f=r;return a._isSecondYAxis(b.graphYAxis)&&h&&(f=h),c.chartData.negativeValues?(b.y0=0,c.side?f(z(b))+f.rangeBand()/A*e:f(b.y<0?0:b.y)):c.side?f(z(b))+f.rangeBand()/A*e:f(b.y)},function(a){return a.sectionLabel})}else this.doBars(y,c,function(a){return a},function(a){return c.chartData.negativeValues?(void 0==a.y0&&(a.y0=0),c.side?Math.abs(Math.abs(q(a.y))-Math.abs(q(0))):q.rangeBand()):c.side?q(a.y):q.rangeBand()},function(b){var d=r;return a._isSecondYAxis(b.graphYAxis)&&h&&!j&&(d=h),c.chartData.negativeValues?(void 0==b.y0&&(b.y0=0),c.side?d.rangeBand():Math.abs(d(0)-d(Math.abs(b.y)))):c.side?d.rangeBand():Math.abs(this.height-d(b.y))},function(a){return c.chartData.negativeValues?(void 0==a.y0&&(a.y0=0),c.side?a.y<0?q(a.y0)-Math.abs(Math.abs(q(a.y))-Math.abs(q(0))):q(a.y0):q(z(a))):q(c.side?a.y0:z(a))},function(b){var d=r;return a._isSecondYAxis(b.graphYAxis)&&h&&!j&&(d=h),c.chartData.negativeValues?(void 0==b.y0&&(b.y0=0),d(c.side?z(b):b.y<0?b.y0:b.y0+b.y)):d(c.side?z(b):b.y0+b.y)});this.drawLineChart(c,b,q,r,!0,f)}},d.prototype.drawLineChart=function(b,d,e,f,g,h){var i,j=b.preview?"4px":b.detail?"3px":"2px",k=b.chartData.data;h&&h.length>0&&h[0]&&(i=h[0]);for(var l=0,m=b.chartData.series.length;m>l;l++){var n=f,o=e;if(a._isSecondYAxis(b.chartData.series[l].graphYAxis)&&i&&(b.side?o=i:n=i),this.isLine(b,l))if(this.isDateLine(b,l)){var p=b.chartData.series[l].varName,q=c.parseEncodedDate(p),r=c.getAbsoluteDate(q.relativeDateOp,q.value),s=this.formatForDateScale(b,r),t=o(b.isTimeSeries&&this.isLine(b)?s.date.startOf("day"):s.label);d.append("svg:line").attr("class","path").datum(l).attr("x1",function(a){return t}).attr("y1",function(a){return 0}).attr("x2",function(a){return t}).attr("y2",function(a){return n.range()[0]}).style("stroke",function(){var a=b.seriesLabel[l].colour;return d3.rgb(a.r,a.g,a.b)}).style("stroke-width",j).style("stroke-dasharray",this.isDashedLine(b,l)?"5, 5":void 0)}else{for(var u=[],v=0;v<k.length;v++)null!=k[v].value[l]&&u.push(k[v]);this.drawLine(b,u,l,b.seriesLabel[l].colour,j,this.isDashedLine(b,l),d,o,n,g)}}this.addTooltip(b,d,null,e,f,i)},d.prototype.addTooltip=function(b,c,d,e,f,g){var h=this,i=c.append("g").attr("class","grid").style("display","none");i.append("line").attr("class","x tick").attr("y1",0).attr("y2",this.height);var j,k;this.isLine(b)?(j=c.append("rect").attr("width",this.width).attr("height",this.height).style("fill","none"),k="all"):(j=d3.selectAll(".path"),k="visible"),j.style("pointer-events",k).on("mouseout",function(){i.style("display","none")}).on("mousemove",function(a){!b.preview&&d3.event&&h.isLine(b)&&h._showTooltipForClosestDataPoint(b,e,f,d3.event,h,d3.mouse(this)[0],i,g)});for(var l=0,m=b.chartData.series.length;m>l;l++)if(this.isLine(b,l)){var n=b.seriesLabel[l].colour,o=d3.rgb(n.r,n.g,n.b).darker(),p="";a._isSecondYAxis(b.seriesLabel[l].graphYAxis)&&b.seriesLabel[l].label&&(p=" y2AxisTooltipText"),i.append("circle").attr("class","y"+l).attr("r",3).style("fill",o).style("stroke",o),i.append("text").attr("class","y1"+l+p).style("stroke","white").style("stroke-width","3.5px").style("opacity",.8).attr("dx",8).attr("dy","-3px"),i.append("text").attr("class","y2"+l+p).attr("dx",8).attr("dy","-3px"),i.append("text").attr("class","y3"+l+p).style("stroke","white").style("stroke-width","3.5px").style("opacity",.8).attr("dx",8).attr("dy","10px"),i.append("text").attr("class","y4"+l+p).attr("dx",8).attr("dy","10px")}},d.prototype._showTooltipForClosestDataPoint=function(b,c,d,e,f,g,h,i){if(!(!e||b.chartData.data.length<=1||b.side)){var j=b.chartData,k=c.invert&&b.isTimeSeries,l=0;k||(l=b.side?0:c.rangeBand()/2);var m=d3.bisector(function(a){return k?a.labelAsDate:c(b.isTimeSeries?a.labelAsDate:a.label)}).left,n=k?c.invert(g):g,o=m(j.data,n,1);o>=j.data.length&&(o=j.data.length-1);var p,q;k?(p=j.data[o-1].labelAsDate,q=j.data[o].labelAsDate):(p=c(b.isTimeSeries?j.data[o-1].labelAsDate:j.data[o-1].label?j.data[o-1].label:b.unassignedMsg)+l,q=c(b.isTimeSeries?j.data[o].labelAsDate:j.data[o].label?j.data[o].label:b.unassignedMsg)+l);var r,s;n-p>q-n?(r=q,b.isTimeSeries&&(s=j.data[o].labelAsDate)):(r=p,b.isTimeSeries&&(s=j.data[o-1].labelAsDate),o--);for(var t=0;t<j.series.length;t++)null==j.data[o].value[t]&&(h.select("circle.y"+t).style("display","none"),h.select("text.y1"+t).style("display","none"),h.select("text.y2"+t).style("display","none"),h.select("text.y3"+t).style("display","none"),h.select("text.y4"+t).style("display","none"));for(var u=[],v=j.data[o].value,w=0;w<v.length;w++)null!=v[w]&&this.isLine(b,w)&&u.push(v[w]);if(0==u.length)return void h.select(".x").style("display","none");for(var x=u.sort(d3.descending),y=[],z=[],A=null,B=null,C=k?c(r):r,D=d,t=0;t<x.length;t++){for(var E=-1,w=0;w<j.data[o].value.length&&-1==E;w++)this.isLine(b,w)&&j.data[o].value[w]===x[t]&&-1==$.inArray(w,z)&&(E=w);var F=d;if(i&&E>=0&&E<j.series.length&&a._isSecondYAxis(j.series[E].graphYAxis)&&(F=i),$.inArray(x[t],y)>-1)h.select("circle.y"+E).style("display","none"),h.select("text.y1"+E).style("display","none"),h.select("text.y2"+E).style("display","none"),h.select("text.y3"+E).style("display","none"),h.select("text.y4"+E).style("display","none");else{z.push(E),y.push(x[t]),1===y.length&&(D=F);var G=0;if(z.length>1){A||(h.select("text.y1"+z[z.length-2]).style("display",null).text(x[t]),h.style("display",null),A=h.select("text.y1"+z[z.length-2]).node().getBBox().height,B=2*A);var H=F(F.domain()[1]-(x[z.length-2]-x[z.length-1]));B>H&&(h.select("text.y3"+z[z.length-2]).style("display","none"),h.select("text.y4"+z[z.length-2]).style("display","none"),A>H&&(G=A-H+1))}else z.length>0&&h.style("display",null);if(h.select("circle.y"+E).attr("transform","translate("+C+","+F(x[t])+")").style("display",null),h.select("text.y1"+E).text(x[t]),h.select("text.y2"+E).text(x[t]),b.isTimeSeries){var I=b.dateScale?b.dateScale:"Days",J=this.formatForDateScale(b,s,I).label;h.select("text.y3"+E).text(J),h.select("text.y4"+E).text(J)}var K=0,L=h.select("text.y1"+E).node().getComputedTextLength(),M=h.select("text.y3"+E).node().getComputedTextLength();M>L&&(L=M),C+L>this.width&&(K=-8-L);var N="translate("+(C+K)+","+(F(x[t])+G)+")";h.select("text.y1"+E).attr("transform",N).style("display",null),h.select("text.y2"+E).attr("transform",N).style("display",null),h.select("text.y3"+E).attr("transform",N).style("display",null),h.select("text.y4"+E).attr("transform",N).style("display",null)}}y.length>0&&h.select(".x").attr("transform","translate("+C+","+D(y[0])+")").attr("y2",f.height-D(y[0])).style("display",null)}},d.prototype.getContainerForNoDataMessage=function(b){return this.isLine(b)?this.svgContainer:a.prototype.getContainerForNoDataMessage.call(this,b)},d});