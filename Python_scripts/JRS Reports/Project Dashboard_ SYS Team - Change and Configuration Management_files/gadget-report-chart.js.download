/*******************************************************************************
 * Licensed Materials - Property of IBM
 * (c) Copyright IBM Corporation 2013, 2021. All Rights Reserved.
 * 
 * Note to U.S. Government Users Restricted Rights:
 * Use, duplication or disclosure restricted by GSA ADP Schedule
 * Contract with IBM Corp.
 *******************************************************************************/
define(["gadget/gadget-base","gadget/span-hierarchy","queries/compact-rendering"],function(a,b,c){function d(a,b){var c=$.parseUrl(a),d=$.queryToObject(c.search.substring(1));for(var e in b){var f=b[e];null===f?delete d[e]:d[e]=f}return a.split("?")[0]+"?"+$.objectToQuery(d)}function e(a){return Math.abs(j)===a?0>j?0:-j:a}function f(a){$(".sort-direction-indicator").html(""),a>0?sortDirection="&#9650;":0>a?sortDirection="&#9660;":sortDirection="&nbsp";var b=Math.abs(a)-1;if(b>=0){var c=$(".sort-direction-indicator").get(b);c.innerHTML=sortDirection}}function g(a,b){for(var c=a.parent(),d=(a.index(),c.index()),e=a.attr("rowSpan"),f=c.parent().find("tr"),g=[],h=0;b>h;h++){e=e?parseInt(e):1,1>e&&(e=1);for(var i=d+e,j=d;i>j;j++)for(var k=f.get(j),l=k.children,m=0;m<l.length;m++){var n=l[m];if(1===n.rowSpan){$(n).siblings().addBack().each(function(a,b){var c=b.rowSpan;c=c?parseInt(c):1,e>=c&&g.push(b)});break}}}return g}function h(b,c,d,e,f,g,h){if(a.apply(this,[b,g]),this.filters=c,this.width=d,this.height=e,this.detail=h,this.constantValues=f&&f.length>0?f:null,this.textDir=o.BidiUtils.getPreferredBaseTextDir(),!g&&!this.filters){var i=$.queryToObject($.urlhash(parent));i.filters&&(this.filters="fields="+encodeURIComponent(i.filters))}var j=this;window.___hasDrilldown=function(a){var b=a.series[0],c=b?b.subreport:null;return c?!0:!1},window.___onDrilldown=function(b,c,d,e,f,g,h){var i=c.series[f],k=i.subreport;if(k){$(".query-tooltip").remove();for(var l=null,m=c.data,n=0,p=m.length;p>n;n++){var q=m[n];q.label===d.label&&(l=q)}l||(l=c.data[e]);var r={},s=null;if(l.drilldown.__fixedDrillDown__){var t=l.drilldown;for(var u in t)if("__fixedDrillDown__"!=u){var v=t[u];(v||""===v)&&(r[u]=v instanceof Array?v:[v])}}else{var w="",x=i?o.HtmlUtils.decodeHtml(i.varName):void 0;if(!x&&""!=x)for(var y in l.drilldown){x=y;break}var t,z=function(a){if(!a)return a;var b=a.lastIndexOf(":");if(-1==b){var c=[];return c.push("__daterangeParm__"+a+"T00:00:00.000Z"),c.push(a+"T00:00:01.000Z"),c}var d=a.substring(0,b+1),e=parseFloat(a.substring(b+1,a.endsWith("Z")?a.length-1:a.length)),f=Math.floor(e),g=Math.ceil(e);if(g>f){var c=[];return c.push("__daterangeParm__"+d+f+(a.endsWith("Z")?".000Z":"")),c.push(d+g+(a.endsWith("Z")?".000Z":"")),c}return a},A=d.group?d.group:c.group,B=null,C={};if(l.drilldown[""]){if(t={},t[x]=l.drilldown[""][x],!t[x]&&l.drilldown[x]){var D,E,F=!1;for(var y in l.drilldown[x])l.drilldown[x][y]===x?(t[y]=x,delete t[x],F=!0):"IS_NULL"===l.drilldown[x][y]?(D=y,E=l.drilldown[x][y]):""==x&&l.drilldown[x][y]&&l.drilldown[x][y].length>0&&(t[y]=l.drilldown[x][y]);!F&&""===x&&D&&E&&(t[D]=E,delete t[x])}if((!Array.isArray(t[x])||0==!t[x][0].indexOf("__daterangeParm"))&&A&&(t[A]=l.drilldown[""][A],("first"===d.calc||"last"===d.calc)&&("Days"===h||"Weeks"===h||"Months"===h||"Years"===h)&&l.drilldownDate&&l.drilldownDate[x])){var G=z(l.drilldownDate[x]);G&&d.value&&(t[x]||(t[x]=d.value),t[A]=G)}A&&!t[A]&&l.drilldown[""][A]&&(t[A]=l.drilldown[""][A]),l.drilldown[""].__multiValuedStringVars__&&l.drilldown[""].__multiValuedStringVars__[x]&&(B={},B[x]=l.drilldown[""].__multiValuedStringVars__[x]),l.drilldown[""].__operatorConstraint__&&l.drilldown[""].__operatorConstraint__[x]&&(C[x]=l.drilldown[""].__operatorConstraint__[x]),l.drilldown[""].__displayVarLabel__&&(t.__displayVarLabel__=l.drilldown[""].__displayVarLabel__)}else{if(t=l.drilldown[x],("first"===d.calc||"last"===d.calc)&&("Days"===h||"Weeks"===h||"Months"===h||"Years"===h)&&A&&l.drilldownDate&&l.drilldownDate[x]){var G=z(l.drilldownDate[x]);G&&d.value&&(t[c.singleAttributeUnit]||(t[c.singleAttributeUnit]=d.value),t[A]=G)}l.drilldown[x].__multiValuedStringVars__&&(B=l.drilldown[x].__multiValuedStringVars__),l.drilldown[x].__operatorConstraint__&&(C=l.drilldown[x].__operatorConstraint__)}var H=t.__displayVarLabel__;for(var u in t){var v=t[u];if((v||""===v)&&!u.match(/^\s*__.*__\s*$/i)){r[u]=v instanceof Array?v:[v];var I=[];r[u].map(function(a,b){if("string"==typeof a&&a.match(/^\s*unassigned\s*$|^\s*unassigned\s*,|,\s*unassigned\s*,|,\s*unassigned\s*$/)){for(var c=a.split(","),d=0;d<c.length;d++)"unassigned"==c[d].trim()&&(c[d]=c[d].replace("unassigned","IS_NULL"));v=c.join(","),I.push(v)}else I.push(a)}),r[u]=I,""!=w&&(w+=", "),w+=H&&H[u]?o.HtmlUtils.decodeHtml(H[u]):"IS_NULL"==v?b.unassignedMsg:v}}""===w&&A&&l&&l.label&&c.series&&1===c.series.length&&""===c.series[0].varName&&(w=A+"="+l.label,r[A]=[l.label]),s=__GadgetMessages.WebUI_Gadget_DrillDown.replace("{0}",w)}var J=a.Exports.ParameterList.buildFilterParamFromValues(r,C);B&&(J=J+"&multiValuedStringVars="+encodeURIComponent(JSON.stringify(B))),j.doDrilldown(k,J,s,l.drilldown.__fixedDrillDown__,g?__GadgetMessages.WebUI_Gadget_DrillDown_Results_Different:void 0)}},this._initialize()}var i="maxRows",j=null,k=null,l=null,m=null,n=null,o=a.Exports,p=o.ParameterList,q=function(){};INHERIT_FROM(h,a,{onColumnResize:function(){l&&(l.css({top:$("#table-viewport").height()}),n=l.find(".pagination-section-controls"),n.removeAttr("style"))},onExecuteTable:function(b,c){this.getParameterList().columnFiltersAsGraph(!1),this.filters=c.filter,this.gadgetSettingsParam=c.gadgetSettingsParam,this.ddFilters=c.ddFilters,this.tablePagination=c.viz.tablePagination,this.href=this._buildReportTableUrl(c.viz);var d=this._getMaxRows(),e=this;$(".items-per-page, .pagination-section").remove(),this._doLoad({initTable:!0,drilldown:c.drilldown},function(){$("#chart-parameters-message").hide(),$("#selectMaxRows").val(d),e.notify(a.Events.Initialized),e.resizeContent(),b&&b(),$("#pagination-bottom-wrapper").appendTo("#jp-page-content"),window.parent.document.getElementById("runReportTab")&&window.parent.$("#runReportTab").is(":visible")&&($("#table-viewport").css({"max-height":window.parent.innerHeight-window.parent.$("#run-report-frame").offset().top-100+"px"}),l&&(l.css({top:$("#table-viewport").height()+50+"px"}),n=l.find(".pagination-section-controls"),n.removeAttr("style")),window.parent.document.getElementById("runReportTab").style.height=window.parent.innerHeight-window.parent.$("#run-report-frame").offset().top+45+"px",window.parent.document.getElementById("run-report-frame").setAttribute("scrolling","no")),window.parent.document.getElementById("view-report-frame")&&window.parent.$("#view-report-frame").is(":visible")&&($("#table-viewport").css({"max-height":window.parent.innerHeight-window.parent.$("#view-frame").offset().top-100+"px"}),l&&(l.css({top:$("#table-viewport").height()+50+"px"}),n=l.find(".pagination-section-controls"),n.removeAttr("style")),window.parent.document.getElementById("view-report-frame").style.height=window.parent.innerHeight-window.parent.$("#view-frame").offset().top+45+"px",window.parent.document.getElementById("view-frame").setAttribute("scrolling","no"))})},onExecuteChart:function(b,c){this.getParameterList().columnFiltersAsGraph(!0),this.filters=c.filter,this.gadgetSettingsParam=c.gadgetSettingsParam,this.ddFilters=c.ddFilters,this.showLoading(!0);var d=this.width?this.width:0,e=this.height?this.height:0;this.hostMode!==a.Modes.OpenSocial&&(0===d&&(d=500),0===e&&(e=500));var f=this.hostMode!==a.Modes.OpenSocial?"false":"true",g=$.expand("{{url}}/view/partial?width={{width}}&height={{height}}&gadgetMode={{gadgetMode}}",{url:__reportDefinitionUrl,width:d,height:e,gadgetMode:f});if(c.viz){var h=c.viz["@id"],i=h.substring(__reportDefinitionUrl.length+1,h.length);g+="&viz="+i}this.hostMode===a.Modes.Embedded&&(g+="&embedded=true"),this.detail&&(g+="&detail=true"),this.gadgetSettingsParam&&(g+="&"+this.gadgetSettingsParam),this.filters&&""!=this.filters&&(g+="&"+this.filters),this.ddFilters&&""!=this.ddFilters&&(g+="&"+this.ddFilters);var j=this;this.loadContent($("#jp-page-content"),g,function(){j.showLoading(!1),j.hostMode===a.Modes.Embedded&&($("#_visualization").css({"min-width":"50px"}),$("#_main").css({"min-width":"50px"})),b&&b(),-1!==window.parent.location.href.indexOf("runReport")&&window.parent.document.getElementById("runReportTab")&&(window.parent.document.getElementById("runReportTab").style.height=window.parent.innerHeight-window.parent.$("#run-report-frame").offset().top+"px",window.parent.document.getElementById("run-report-frame").setAttribute("scrolling","yes")),-1===window.parent.location.href.indexOf("runReport")&&window.parent.document.getElementById("view-report-frame")&&(window.parent.document.getElementById("view-report-frame").style.height=window.parent.innerHeight-window.parent.$("#view-frame").offset().top+"px",window.parent.document.getElementById("view-frame").setAttribute("scrolling","yes"))})},doDrilldown:function(a,b,c,d,e){this._super(a,this.filters);var f=this;if(0!=a.indexOf(this.reportUrl)||d)this.loadContent($("#initState"),a+"/view/gadget?state=init",function(){new h(a,b).start(f.history)});else{var g=function(a,b,c,d){$(".gadget-breadcrumb").html(""),f._selectedViz=a,f._isDrillDown=d,$("#show-parameters").hasClass("hide")||(d?$("#show-parameters").hide():$("#show-parameters").show()),f._doExecute(null,{viz:f._vizMap[a],drilldown:d,ddFilters:b,warningMsg:d?e:void 0}),f.displayVizDropdown(c)},i=(this.filters,this._selectedViz),j=!1,k=0;for(var l in f._vizMap)k++;var m=k>1;g(a,b,!1,!0),this.history&&this.history.push({title:c,end:function(){g(i,null,m,j)}}),this.renderHistory()}}}),h.prototype.tableShowLoading=function(a){a?this.previewing||($("#table-viewport").length>0?($("#table-viewport").addClass("hide"),$("#pagination-bottom-wrapper").addClass("hide"),$("#tableLoadingProgress").removeClass("hide"),this.widgetContentSpinner.spin($("#table-widget-content-spinner")[0])):($("#jp-page-content").addClass("hide"),$("#loadingProgress").removeClass("hide"),this.widgetContentSpinner.spin($("#widget-content-spinner")[0]))):this.previewing||($("#table-viewport").length>0?($("#table-viewport").removeClass("hide"),$("#pagination-bottom-wrapper").removeClass("hide"),this.widgetContentSpinner.stop(),$("#tableLoadingProgress").addClass("hide")):($("#jp-page-content").removeClass("hide"),this.widgetContentSpinner.stop(),$("#loadingProgress").addClass("hide")))},h.prototype._doLoad=function(c,e){var f=c.sort;if(c.href&&(this.href=c.href),c.href&&(this.href=c.href,this.href=this.href.replace("/view?","/view/partial?").replace("&init=true","").replace("?init=true&","?").replace("?init=true","")),f){var h=Math.abs(f)-1,i=0>f?"d":"";this.href=d(this.href,{sort:h+i}),j=f}else this.href=d(this.href,{sort:null}),j=null;var n=m,p=this.href;c&&c.initTable&&(n=$("#jp-page-content"),p+="&init=true"),c&&c.drilldown&&(p+="&dd=true");var r=this.showLoading;c.noLoading&&(r=q),this.tablePagination||this.hostMode===a.Modes.Embedded&&$("#_prompts").display(!1),this.tableShowLoading(!0);var s=this;c.noLoading||s.getParameterList().hideFilters(),this.loadContent(n,p,function(){s.getParameterList().applyColumnFilters(),$(".panel.inline-filter.resizable").each(function(a,b){s.resizableDialog.handleDialogResize(b,{nonModal:!0})}),o.BidiUtils.setTextDir(s.textDir),c&&c.initTable&&(k=$(".pagination-section"),m=$("#_resultBody")),s.tablePagination?(k.html(m.find(".new-pagination-controls > td").html()),l=$("#pagination-bottom")):(k.html("&nbsp;"),k.display(!1),$(".items-per-page").html("&nbsp;"),$(".items-per-page").display(!1),$("#_visualization").css({"min-width":"50px"}),l=null),s.tableShowLoading(!1),s._processDrilldowns();var d=m.find(".new-pagination-controls > td > .pagination-section-controls").children();if(d.length<2&&""===$(d[0]).html()){k.html("&nbsp;");var f=m.siblings("thead").find("tr > th");f.length>0&&m.find("td[colspan=0]").attr("colspan",f.length)}if(s.hostMode===a.Modes.OpenSocial){var h=s.getSectionHeight("#_main");$("#jp-page-content");h-=$("#subHeader").height(),h-=50,l&&($("#pagination-bottom-wrapper").display(!1),l=null)}-1==s.href.indexOf("sort=")?b.doSpan(m):m.find(".query-data-items").remove();var i,j=$(".query-results-table thead tr th").length;$(".query-results-table  tbody tr td").hover(function(){var a=$(this);tdNodes=g(a,j),i=$(tdNodes),i.addClass("table-rowspan-hover")},function(){i.removeClass("table-rowspan-hover")}),$execTime=m.find(".queryExceutionTimeData").attr("timeInMs"),null!==$execTime&&$("#Exec-Time").html($execTime);var n=$(".truncationTooltip");n&&n.length>0&&($(".limitTooltip>img").attr("style",""),$(".limitTooltip .limitTooltipTitle")[0].innerHTML="",$(".limitTooltip .limitTooltipTitle").append(n[0].innerHTML)),s.notify(a.Events.TablePageMoved),e&&e()},function(){s.tableShowLoading(!1)})},h.prototype._initialize=function(){var b=this,c=null;this.on(a.Events.Initialized,function(){function a(a,b){var c=$(".sortable").index(a),d=e(c+1),f=$(a).find(".sort-direction-indicator");d>0&&f.html(b)}m=$("#_resultBody"),$(".sortable").offon("click",function(){var a=$(".sortable").index(this);c=e(a+1);var d={noLoading:!0,drilldown:b._isDrillDown,viz:b._vizMap[b._selectedViz]};0!=c&&(d.sort=c),b._doLoad(d),f(c)}),$(".sortable").hover(function(){a(this,"&#9651;")},function(){a(this,"")}),$("#selectMaxRows").change(function(){b.setUserPref(i,$("#selectMaxRows").val()),b._doExecute(null,{viz:b._vizMap[b._selectedViz],drilldown:b._isDrillDown,ddFilters:b.ddFilters})}),$(window).resize(function(a){if(l){var b=$("#table-viewport").height();b&&l.css({top:b+50+"px"}),n=l.find(".pagination-section-controls"),n.removeAttr("style")}})}),this.on(a.Events.TablePageMoved,function(){$(".pagination-section-controls").on("click",function(a){var d=$(a.target);"IMG"===a.target.tagName&&(d=d.parent());var e=d.attr("href"),f=d.attr("class");if(e&&(d.is("a")||"pagination-page-link"===f)){var g={href:e,sort:c};b._doLoad(g),a.preventDefault()}}),$("#table-viewport").scrollTop(0),l&&(l.css({top:$("#table-viewport").height()+60+"px"}),n=l.find(".pagination-section-controls"),n.removeAttr("style"))})},h.prototype._processDrilldowns=function(){var a=this;$(".drilldown").each(function(b,c){var d=$(c),e=d.data("reporturl"),f=e.split("/"),g=f[f.length-1];f=g.split("#"),g=f[0];var h=null;f.length>1&&(h=f[1]);var i=d.data("variable"),j=d.data("valueconstraint"),k=d.data("multivaluestringseparator"),l=d.data("operatorconstraint"),m=d.data("relativedatedaysbefore"),n=d.data("relativedatevar"),q=d.closest("tr"),r=q.data("values"),s="[object Array]"===Object.prototype.toString.call(r),t="[object String]"===Object.prototype.toString.call(r),u=s||t?JSON.parse(o.HtmlUtils.decodeHtml(r)):r,v={},w={},x=void 0,y=d.data("varnames").split(","),r="";$.each(y,function(a,b){var c;if(b==i&&j){if(c=j,j.length>0){var d=[];if(2==j.length&&"string"==typeof j[0]&&0==j[0].indexOf("__daterangeParm__"))if(n&&m){var e=u[n],f=moment(e),g=void 0;m>0?g=f.subtract:0>m&&(g=f.add,m=-1*m);var h=g?g.call(f,m,"days").format("YYYY-MM-DD"):void 0;h?(d.push("__daterangeParm__"+h),d.push(h)):d=j}else d=j;else j.map(function(a,b,e){if("string"==typeof a&&a.match(/^\s*unassigned\s*$|^\s*unassigned\s*,|,\s*unassigned\s*,|,\s*unassigned\s*$/)){for(var f=a.split(","),g=0;g<f.length;g++)"unassigned"==f[g].trim()&&(f[g]=f[g].replace("unassigned","IS_NULL"));c=f.join(","),d.push(c)}else d.push(a)});v[b]=d,x||(x={}),x[i]=k,w[i]=l}}else c=u[b],c&&""!==c?v[b]=[c]:v[b]=["IS_NULL"];""!=r&&(r+=", "),r+=c});var z=d.data("var-label"),A=p.buildFilterParamFromValues(v,w);x&&(A=A+"&multiValuedStringVars="+encodeURIComponent(JSON.stringify(x))),A+="&fromViz=table";var B=null!=z?z:__GadgetMessages.WebUI_Gadget_DrillDown.replace("{0}",r);if("0"==d.text()){var C=d.parent();d.remove(),C.append("<p>0</p>")}else{var D=a.getPrefValues();D&&(D=a._buildFilterVarString(D));var E=$(document).data("reportViewUrl"),F=$(document).data("reportViewUrl").lastIndexOf("#");-1!=F&&(E=E.substring(0,F));var G=E+"#view="+g;D&&(G+="&filterValues="+encodeURIComponent(D),A&&(G+="&"+A),h&&(G+="&dd=true&viz="+h)),d.attr("href",G).reclick(function(){return a.doDrilldown(e,A,B),!1})}})},h.prototype._getMaxRows=function(){var b=this.getUserPref(i);if(b&&b>0)return b;var c=this.hostMode!==a.Modes.OpenSocial?"20":"10";return $("#selectMaxRows").val()||c},h.prototype._getGadgetMode=function(){var b=this.hostMode!==a.Modes.OpenSocial?"false":"true";return b};var r="/view/partial?pageIndex=0&maxRows={{maxRows}}&gadgetMode={{gadgetMode}}";return h.prototype._buildReportTableUrl=function(a){var b=this.reportUrl;if(b+=$.expand(r,{maxRows:this._getMaxRows(),gadgetMode:this._getGadgetMode()}),a){var c=a["@id"],d=c.substring(__reportDefinitionUrl.length+1,c.length);b+="&viz="+d}return this.gadgetSettingsParam&&(b+="&"+this.gadgetSettingsParam),this.filters&&(b+="&"+this.filters),this.ddFilters&&(b+="&"+this.ddFilters),b},h});